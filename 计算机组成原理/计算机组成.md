# 第一章 计算机系统概论

## 冯诺依曼型计算机特点

- 1.计算机由运算器，控制器，存储器，输入和输出设备5部分组成
- 2.采用存储程序的方式，程序和数据放在同一个存储器中，并以二进制表示。
- 3.指令由操作码和地址码组成
- 4.指令在存储器中按执行顺序存放，由指令计数器(即程序计数器PC)指明要执行的指令所在的储存单元地址，一般按顺序递增，但可按运算结果或外界条件而改变
- 5.机器以运算器为中心，输入输出设备与存储器间的数据传送都通过运算器
- 

## 计算机系统组成

- 计算机系统有硬件（效率高）和软件（灵活性强）组成，硬件包括中央处理器、存储器和外部设备等；计算机软件是指计算机系统中的程序和文档；程序是计算任务的处理对象和处理规则描述；文档是便于了解程序所需的阐明性资料。

## 区别以运算器为中心的计算机还是存储器的方法

- 看输入设备能否直接与存储器相连，是的话就是以存储器为中心

## 计算机系统

- 硬件

	- 结构

		- 主机

			- cpu

				- ALU运算器

					- 运算器是对信息进行处理和运算的部件，进行算术和逻辑运算，核心是算术逻辑单元（ALU),算术运算为加减乘除，逻辑运算为与、或、非、异或、比较、移位等。
运算器包括若干通用寄存器，用于暂存操作数和中间结果，必须有累加器（ACC)、乘商寄存器（MQ）、操作数寄存器（X)

				- CU控制器

					- 控制器由程序计数器（PC)、指令寄存器（IR）和控制单元（CU)组成。PC用于存放当前预执行指令的地址，可以自动+1形成下一条指令的地址，与主存的MAR有直接通路。IR存放当前指令。内容来自主存的MDR。指令中的操作码字段OP（IR）送至CU，用于分析指令并发出微操作命令序列；指令中的地址码字段Ad（IR）送至MAR来取操作数。
					- CPU可以根据指令周期的不同阶段区分指令和数据，再取值阶段取出指令，其他阶段为数据；也可以根据地址来源不同划分，指令地址来自程序计数器，数据地址来自地址形成部件或指令的地址码字段
指令寄存器的操作码送入操作码编译器译码，与时钟和节拍脉冲发生器合作产生一个时序控制信号，并将操作码译码器的结果一同送入微操作控制器，形成“一操作+一时间”的格式
指令的地址码送入地址形成部件，若为转移地址送入PC;若为操作数地址送入存储器的地址译码器去取操作数，取出的操作数先放在数据寄存器，再送往计算器进行运算。
每读取一条指令，PC内容自动+1，以上指令重复执行，直至打印出结果，最后执行停机指令，机器自动停机。

			- 存储器

				- 主存储器（CPU直接访问，存放程序和数据）
				- 辅助存储器（先进入主存后再被CPU访问，主要帮助主存记忆信息）
				- ![](assets/0e0d17973b7e1810d1bb0551300f225839c1f286c1fe43a26943d848f8bdb638.png)
				- 存储体存放二进制信息，地址寄存器（MAR）存访存地址，须经地址译码器处理找到存贮单元，数据寄存器（MDR）用于暂存主存读写数据。MAR和MDR属于存储器但存在于CPU。

					- ![](assets/b589cae816455fa9a509a180049a4d23621c6aa091711ea57fc19ee97ffc0d8e.png)
					- 存储器取出的数据要先存在数据寄存器中，数据寄存器的位数和存储字长要相等。

				- 寻址范围

					- 1、已知存储器容量和字长，按字节寻址操作为 【 容量8（1M = 8Mbit）】 / 【8 bit(一字节位数）】；按字寻址时： 【容量 * 8（1M = 8Mbit）】 / 【8 bit(一字节位数） 4 】
2、只知数据线和地址线的位数，按字节寻址操作为计算 【2 ^ (地址线数）】
3、按字寻址为 计算数据线数（存储滋字长）的平方根计算出一个存储字的字节数，推算出几个地址线作为字内寻址（2^n)，剩余的的地址线表示寻址范围。
字地址为连续存储单元地址的最小值，若地址一个字为32位，按字节编址，字地址为4倍数的地址。
4、存储器容量为1MB（1MB = 2^20 bit),如存储容量为nMB，一律默认为nMB8，地址线和数据线的总和为 【20*n + 8】

		- I/O

			- 输入设备
			- 输出设备

	- ![](assets/04ec2f465976d5d89ad45f634159929d2592b75ec746bb3356aeea956a928cc9.png)
	- 五大结构的关系

		- 1、通过与控制器之间的信号请求，输入设备先输入信息给存储器，信息包括数据和程序
2、控制器调用相应的指令运行程序，然后发出相应的操作命令给运算器，控制器给出操作数的地址，根据地址从存储器调用操作数给运算器进行运算
3、运算结果返回存储器，需要打印，则通过输出设备和控制器之间的信号请求打印
		- ![](assets/0776d00a207fc901e2512880b0d37c5604b95e6436c2c41dfaf0bac249c11d03.png)

	- 主要技术指标

		- 机器字长（CPI）

			- CPU一次能处理的数据位数

		- 存储容量

			- 存储容量＝存储单元个数×存储字长

		- 运算速度

			- 单位时间执行指令的平均条数，MIPS

- 软件

	- 系统软件

		- 用来管理整个计算机系统 

			- 语言处理程序
			- 操作系统
			- 服务性程序
			- 数据库管理系统
			- 网络软件

	- 应用软件

		- 按任务需要编制成的各种程序

	- 编译程序生成目标代码，使用高级语言源程序作为输入进行翻译转换为机器语言的目标程序并执行。
解释程序源语言书写的源程序作为输入，解释一句执行一句，不形成目标程序。

- 计算机的层次结构

	- ![](assets/00af995a41669acccbc2b86c8d266052f6d404269394cb7e614d6fb66f62c859.png)

## 计算机性能指标

- 吞吐量

	- 吞吐量指信息流入、处理和流出系统的速率。吞吐量只要取决于主存的存取周期。

- 响应时间

	- 响应时间是指提交作业到该作业得到的CPU响应所经历的时间。响应时间越短，吞吐量越大。

- 主频

	- 主频是机器内部的时钟频率，是衡量机器速度的重要参数; 时钟周期 = 1 / 主频（Hz) ；主频为24MHz的意思是每秒中包含24M个时钟周期

- CPU周期

	- 又称机器周期，用从内存读取一条指令字的最短时间定义。一个指令周期常由若干个CPU周期构成

- CPU时钟周期

	- 主频的倒数，是CPU的最小时间单位

- CPI、MIPS、FLOPS、IPC

	- CPI：执行一条指令所需要的时钟周期
MIPS：每秒可执行百万条指令数
FLOPS：每秒执行的浮点运算次数
IPC: CPU的每一个时间周期内执行的指令数。

- CPU执行时间

	- CPU执行时间是指CPU对某特定程序的执行时间。

- 程序执行时间=程序指令数x每条指令时钟(CPI)x时钟周期T,

# 第二章 运算方法和运算部件

## 数据的表示方法和转换

- 机器数正0负1

	- 符号数值化的带符号二进制数，称为机器数。

- 真值:符号位加绝对值
- 8421码

	- 权值从高到低为8、4、2、1

		- 算术运算时，需对运算结果进行修正。           方法：如果小于、等于(1001)2，不需要修正；否则加6修正

- 余三码:在8421码的基础上，把每个编码都加上0011

	- 当两个余三码相加不产生进位时，应从结果中减去0011;产生进位时，应将进位信号送入高位，本位加0011

- 2421 码

	- 和8421码相似

- 格雷码:任何两个相邻编码只有1个二进制位不同，而其余3个二进制位相同

## 带符号的二进制数据在计算机中的表示方法及加减法运算

- 原码

	- 定义

		- 最高位为符号位0/1+数值的绝对值形式

	- 特点

		- （1）值+0，-0的原码分别为00000、10000，形式不唯一；
		- （2）正数的原码码值随着真值增长而增长

			-      负数的原码码值随着真值增长而减少

		- （3）n+1位原码表示定点整数范围－(2^n－1)——2^n－1

			-      n+1位原码表示定点小数范围 －(1－2^－n)——1－2^－n

	- 运算

		- 绝对值相加减，由数值大小决定运算结果符号

- 补码

	- 定义，特点和运算

		- 运算:
结果不超过机器所能表示范围时，[X+Y]补=[X]补+[Y]补
减法运算:
[X–Y]补=[X+(–Y)]补=[X]补+[–Y]补
		- 结论

			- 负数的补数＝模＋负数
			- 互为补数的绝对值相加＝模
			- 在补数中，减法运算即加法运算

		- 定义

			- X为正数，则符号0+X的绝对值；X为负数，则X的绝对值取反+1。

		- 特点

			- 数值零的补码表示唯一
			- 正数补码码值随着真值增大而增大，负数补码码值随着真值增大而增大
			- 不论真值是正是负，只需将[x补],连同符号位在内每位取反，未位加1，即可得[-x补]
			- n+1位补码所表示定点整数范围－ 2^n——2^n－1，
n+1位补码所表示定点小数范围－1——1－2^－n

	- 加法运算逻辑事例

		- 加减法运算的溢出处理

			- 溢出定义

				-  当运算结果超出机器数所能表示的范围

			- 加减中，可能产生溢出的情况

				- 可能出现溢出

					- 同号数相加
					- 异号数相减

				- 不可能出现溢出

					- 异号数相加
					- 同号数相减

			- 判断溢出的方法

				- 法一：当符号相同两数相加，结果符号和加数（或被加数）不相同，则溢出

					- fa,fb表示两操作数（A,B）的符号位,fs为结果的符号位

				- 法二：任意符号相加，如果C=Cf，则结果正确，否则溢出；

					- C为数值最高位的进位，Cf为符号位的进位

				- 法三：采用双符号相加，如果fs1=fs2，则结果正确，否则溢出；

					- 运算结果的符号位为fs2；
					- 多符号位的补码，叫做变形补码；
					- 如果采用双符号位，当数为小数时，模m=4;当数为整数时，模m=2的n+2次方

- 反码

	- 定义

		- X是正数，[X]反=[X]原；X是负数，符号+数值取反。

	- 特点

		- 数值零的反码表示不唯一
		- 正数反码码值随着真值增大而增大，负数反码码值随着真值增大而增大
		- n+1位反码所表示定点整数范围－ (2^n－1)——2^n－1，n+1位反码所表示定点小数范围－(1－2^－n)——1－2^－n

	- 加减运算特点

		- 在机器数范围内，反码运算满足[X+Y]反=[X]反+[Y]反
，[X－Y]反=[X]反+[－Y]反

	- 反码运算在最高位有进位时，要在最低位+1，此时要多进行一次加法运算，增加了复杂性，又影响了速度，因此很少采用

- 移码

	- 由来及窍门

		- 为了从码值直接判断对应真值的大小，所以引进移码
		- [X]补的符号位取反，即得[X]移 

	- 特点

		- 最高位是符号位，1表示正，0表示负
		- 数据0有唯一的编码
		- 移码码值随着真值增大而增大
		- n+1位移码所表示定点整数范围－ 2^n——2^n－1， n+1位移码所表示定点小数范围－1——1－2^－n
		- 计算机中，移码常用于表示阶码，故只执行加、减运算
		- 计算机中，移码运算公式需要对结果进行修正

	- 浮点数的阶码运算

		- 移码定义:[X]移=2的n次方+X
		- 补码定义:[Y]补=2的n+1次方+Y
		- 阶码求和公式

			- [X]移+[Y]补=[X+Y]移  mod2的n+1次方
			- [X]移+[-Y]补=[X-Y]移
			- 判溢方法

				- 两位符号位

					- 双符号位参加运算，最高符号位恒置0
					- 当结果最高符号位=1则溢出

						- 低位符号=0，则下溢；低位符号=1，正常；

					-  当结果最高符号位=0则未溢出

						- 低位符号=0，正数；低位符号=1，上溢

				- 单符号位

					- 实际参加操作的两个数(减法时即为被减数和“求补”以后的减数)符号相同，结果又与原操作数的符号不同，即认为溢出。
					- 通过数值部分最高位的进位(或者称为最高有效位)和符号位产生的进位进行“异或”操作，然后按照“异或”的结果进行判断。

- 补，反，原，移码的相互转换

	- 反码-》原码

		- 方法：符号位不变，正数不变，负数数值部分取反。

	- 补码-》原码

		- 方法1：正数不变，负数数值部分求反加1。
		- 方法2：串行转换

			- 从最后开始数，遇到第一个“1”，除第一个“1”不变，前面数字分别取反

	- 移码-》原码

		- 方法：移码转换为补码，再转换为原码

- 移位运算

	- 逻辑移位

		- 逻辑左移时，高位移丢，低位补0；逻辑右移时，低位移丢，高位添0

	- 算术移位

		- ![](assets/42fc5f1367b208ceafec071fa521f65360ad206d0a2a615502a91f2cc972dc91.png)

- 定点数和浮点数

	- 定点数

		- 小数点固定在某个位置上的数据

			- 32位定点小数、定点整数补码的范围

				- 32位定点小数-1～1-2-31
				-  32位定点整数-231～231-1

	- 浮点数

		- 根据IEEE754国际标准，常用的浮点数有两种格式

			- Nmax=Mmax*2的Emax
Nmin=Mmin*2的Emax
			- 单精度(32位)=8位阶码+24位尾数

				- 单精度浮点数(32位)，阶码8位(含一位符号位)，尾数24(含一位符号位)，取值范围:-2的127次方～(1-2的-23次方)*2的127次方

			- 双精度(64位)=11位阶码+53位尾数

				- 双精度浮点数(64位)，阶码11位(含一位符号位)，尾数53位(含一位符号位)，取值范围:-2的1023次方～(1-2的-52次方)*2的1023次方

		- 为了保证数据精度，尾数通常用规格化形式表示:当R=2，且尾数值不为0时，其绝对值应大于或等于(0.5)10

			- 左规
			- 右规

		- 小数点位置可以浮动的数据。
		- 表示形式：N = M · R^E
		- 计算机中存储形式

			- Ms+Es+E(n位)+M(m位)

				- 阶码E，一般为整数，用补码或者移码表示；
				- 尾数M，一般为规格化的定点小数，用补码表示；

## 二进制乘法运算

- 定点原码一位乘法

	- 两个原码数相乘，其乘积的符号为相乘两数符号的异或值，数值则为两数绝对值之积

		- [X·Y]原=[X]原·[Y]原=(X0⊕Y0)|(X1X2..Xn) · (Y1Y2..Yn)

	- 几点结论

		- 从低到高根据乘数每位0、1决定相加被乘数还是0；
		- 相加数每次左移，最后一起求积；
		- 符号由异或决定

	- 修正

		- 1.在机器内多个数据一般不能同时相加，一次加法操作只能求出两数之和，因此每每求得一个相加数，就与上次部分积相加
		- 2.人工计算时，相加数逐次向左偏移一位，由于最后的乘积位数是乘数(或被乘数)的两倍，如按此算法在机器中运算，加法器也需增到两倍。观察计算过程很容易发现，在求本次部分积时，前一次部分积的最低位不再参与运算，因此可将其右移一位，相加数可直送而不必偏移，于是用N位加法器就可实现两个N位数相乘
		- 部分积右移时，乘数寄存器同时右移一位，这样可以用乘数寄存器的最低位来控制相加数(取被乘数或零)，同时乘数寄存器的最高位可接受部分积右移出来的一位，因此，完成乘法运算后，A寄存器中保存乘积的高位部分，乘数寄存器中保存乘积低位部分

			- ![](assets/725356407808989c95a3a38b13cdd5cc754ad418df77f3d5ec1c5eea8bb81840.png)
			- 乘法运算可用移位和加法来实现，两个n位数相乘，共需要进行n次加法运算和n次移位操作

- 定点补码一位乘法

	- [X·Y]补=[X]补·(Y0+Y1·2-1+….Yn·2-n)
	- 校正法

		- 注意：此处为双符号位（用于避免移位操作丢失符号位），y（被乘数）为负数时，需要补充加上[-|x|]补的校正操作，否则不用校正
		- ![](assets/402bb282cdea64f68341733b40ccc5fcafa11d106c689f611778c32d974faebf.png)
		- ![](assets/04d302f868c84465ad4481827fa5f907fb0dcac91f3fb1a8d51e3fe3b8141ff0.png)

	- 比较法

		- 规则

			- ①使用双符号位，避免丢失符号位
②乘数取单符号位以决定最后一步是否需要校正， 即是否加[-x]补。
③乘数末尾增设附件位yn+I,初始值为0。
④根据yn，yn+I判断位，进行运算，步骤同上。
⑤按上述算法进行n+1步，但是第n+1步不再移位，仅根据yo、y1 比较结果决定是否要加减[x]补。
⑥按补码移位规则，即部分积为正时，右移过程中有效位最高位补0;部分积为负时，右移过程中有效位最高位补1;双符号的移位前面已经讲过了，次高符号位是参与移位的，最高符号位不参与。

				- ![](assets/eb0be287fa970e1b360ff31577a73084329ea3a35eeb314544b030b52f92ddb3.png)

		- ![](assets/78fe8db91da89d544e6c31f56987af8b5724ee21d8b248c3f7f82ebdaec0bef2.png)

			- ![](assets/b47ccbf36c24a980f2f26871b9e6a31175a6003a7f4e3c5c729d6f4aa52bec8a.png)

## 二进制除法

- 加减交替法(不恢复余数）

	- 当余数为正时，商上1，求下一位商的办法是，余数左移一位，再减去除数;当余数为负时，商上0，求下一位商的办法是，余数左移一位，再加上除数。此方法不用恢复余数，所以又叫不恢复余数法。但若最后一次上商为0而又需得到正确余数，则在这最后需恢复余数
	- 原码不恢复

		- 过程

			- ![](assets/aa3daf736c90594d45c84c45ed0f2c429e80c4d2b2ef0417502970314b948f3c.png)

		- 示例

			- ![](assets/02cd3c5b5b65f755ea8e229c447ab18983bf5124a1b72d773b66083f80a85dcc.png)

	- 补码不恢复

		- 过程

			- 确定商值

				- ![](assets/ba7e78ef0ec625637ee5c6a9f0981939ee07cb06e348a3f6d025b69df26d89be.png)

			- 形成商符

				- ![](assets/4837f304d74ad1e0e6e2993ed5e7390d3a400f99f3354535fb8515f0665f1e2c.png)

			- 确定新余数

				- ![](assets/4f77ff406531961332575b9e484605401ad182b71244e9c1928fc59fdb71d5d2.png)

		- 示例

			- ![](assets/4393c1f9070265b94dcf358a9ee32d8f84b9abddd7201e4b2fcad2b48c4c3c65.png)

- 原码恢复余数法

	- 过程

		- ![](assets/3ec55d1326ae3a68815e13275f88f9efe4785c013c0db9a929e1f0a1378ac370.png)
		- ![](assets/8797f0b90a15758e654119c6cf343e49a9b1f2d9f1e64ea5b506e4fd2b494a2e.png)

	- 示例

		- ![](assets/742506dbf9f4518e6e09902df9041e99dd4801358301f763f791d4fee3fc8368.png)

			- ![](assets/4b2b374656e475f5d5ff0636d8827e39028a977c5a58c8b886618b0ca59f0087.png)

- 扩展

	- ![](assets/d173844f104c9b1ca9b93c17a2fd15d5de9d0c3b6b6b09ad3c94b6891a219fb1.png)
	- ![](assets/51dbdd2bb183931411c09719ebe1893c9b31cd054fc18c73b5e705ec6f0a73b8.png)

## 浮点数的运算方法

- 浮点数的加减法运算

	- 1.对阶操作

		- 求出△E，再对小的进行移位

	- 2.尾数的加减运算
	- 3.规格化操作

		- 规则简化是符号位和数值最高位不同，即00.1xxxx或11.0xxxx

			- ![](assets/446311b2dc387c4febcb1bac216b24bd99a3c723ce164457e50d2c5491c2e689.png)

	- 4.舍入

		- 超出表示范围的高位为1舍入，考虑尾数右移丢失的数值位

			- 0舍1入
			- 恒置1法

	- 5.检查阶码是否溢出

		- ![](assets/a35f8a379613e4153d446534be13c0b66b9fa2dffef543f3faaa0bb10182e2cf.png)

	- 示例

		- ![](assets/5bd565ad99dd561633f551aa5270aef0669ada363f35093d627880c90ec3053b.png)
		- ![](assets/78d6c1600923d1840198166fc29516a770e26c33a72a8dfc28b01844d704ce64.png)

- 浮点数的乘除法运算

	- 1.浮点数阶码运算(移码)

		- 牢记公式

			- [X+Y]移=[X]移+[Y]补
			- [X–Y]移=[X]移+[–Y]补

	- 2.按照一位乘或加减交替除运算

		- 先确定符号，在列式子计算

- 表示

	- 尾数用原码表示，阶码用移码表示![](assets/8681462849a7184d0e6f5916cc025f76d87e5afb40e536c2c9bb53b966180807.png)

		- ![](assets/51df2e76949a4b7c6ce9e0e6f104310a961f2fd48e1b1e61d94619d119bd7149.png)

	- ![](assets/ae4602a9e8ec300da63be898e58e60db8b8ae1e547d1b25f5ec951b8e7c31076.png)

## 运算部件

- ABC寄存器作业
- 定点运算部件
- 浮点运算部件

	- 由阶码运算部件和尾数运算部件组成

## 数据校验码

- 码距

	- 任意两个合法码之间不相同的二进制位数的最小值

		- 要具有差错能力，则码距>1
		- 合理增大码距，就能提高发现错误的能力

- 鉴定方法

	- 有无差错能力
	- 是否能合理增大码距

- 奇偶校验码

	- 能发现数据代码中一位或奇数个位出错情况的编码，方式为添加一个校验码，使得码字中1的个数为奇数或偶数。
	- 结论

		- （1）奇偶校验码只能发现一位或奇位错，且不能确定出错位置
		- （2）奇偶校验码的码距=2

- 海明校验码

	- 海明码位号和校验位位号的关系

		- Pi的位置在2的i-1次方，但是除了最高位

	- 海明码码距为4
	- 纠一位错，查一位错

		- 2∧r≥k+r+1

	- 纠一位错，查两位错

		- 2∧(r–1)≥k+r

	- 编写过程

		- 1)确定校验位的位数r，2^r-1>=k+r
		- 2)把海明码按序写出来MN，.，. M1,校验码Pi(i取1、2、3、.... m)在编码中的位置为2^(i-1),将校验码的位置写出来，然后将数据位按序填入海明码。

			- ![](assets/f16b1e5ecca7d2d1daaadf7ab2655256c25d33ba85c393d24899158528e51f18.png)

		- 3)根据校验位和数据位的关系，依次计算出校验码Pi(i取1、2、3、.... m),将Pi填入海明码。

a、每个数据码都由多个校验码共同校验，但要满足一个条件:被校验数据码的海明位号等于校验该数据码的各校验码海明位号之和，且校验码不需要再被校验。例如，DI的海明位号为3(D1放在M3的位置上)，则D1由P2P1校验,(P2放在M2的位置上,PI放在M1的位置上,3=2+1)
b、校验位Pi的值即为所有需要Pi校验的数据位求异或。

	- 校验过程

		- 1)直接写出出错位eN，.，. e1与MN，.，. M1的对应关系，计算eN，.，. e1的值。针对海明码的下标使用二进制表示，其中ei的值为1，则说明ei与Mi有关，使用“异或”操作进行计算，若海明码没有错误，eN，.，. e1全为0.
2)求出二进制序列eN，.，. e1对应十进制的值，则此十进制数就是出错的位数，取反即可得到正确的编码

- 循环冗余校验码(CRC)

	- CRC码可以发现并纠正信息存储或传送过程中连续出现的多位错误
	- CRC码一般是指k位信息码之后拼接r位校验码
	- 模2运算

		- 模2加减
		- 模2乘除

			- 1、除法过程中，计算余数，全部使用“异或”操作
2、上商规则取部分余数的首位
3、部分余数的位数小于除数的位数时，得到最后余数

				- ![](assets/6ab71989d475700130fcbd3e322063a63aac85035b1795fb2df40321ec5dce4e.png)

		- 异或逻辑

	- CRC的译码与纠错

		- 更换不同的待测码字可以证明:余数与出错位的对应关系是不变，只与码制和生成多项式有关
		- M(x)代表发送信息的多项式，G（x)为生成多项式，代表校验位信息

1、将M(x)和G(x)转化为二进制，多项式各项次数代表位置，系数为该位置上二进制位的值。
2、将M(x)表示的二进制码左移G(x)的最高位数，等到M'(x）
3、将M'(x）对G(x)进行模2除法的余数，将余数与M(x)合并得到循环冗余校验码。

# 第三章 存储器层次结构

## 存储器分类

- 存储介质

	- 半导体存储器可随机访问任一单元，而辅助存储器一般为串行访问存储器
	- 磁表面存储器

		- 数字式磁记录

			- 硬盘、软盘和磁带

		- 模拟式磁记录

			- 录音、录像设备

	- 光存储器

		- 光盘

- 存取方式

	- 随机存储器

		- 随机存储器(RAM)按存储元件在运行中能否长时间保存信息分为静态存储器和动态存储器
		- 静态存储器，利用触发器保存信息，只要不断电，信息就不会丢失
		- 动态存储器，利用MOS电容存储电荷来保存信息，需要不断给电容充电才能使信息来保存信息

	- 只读存储器（ROM)

		- 只读存储器ROM

			- 只读不能写

		- 可编程序的只读存储器PROM

			- 一次性写入

		- 可擦可编程序的只读存储器EPROM

			- 可多次写入、读出

		- 可电擦可编程序只读存储器E2PROM

			- 可多次读出但写入次数有限

		- 快擦除读写存储器Flash Memory

			- 重复写入、读出

	- 串行存储器

		- 顺序存取存储器
		- 直接存取存储器

- 作用

	- 主存储器(主存)、辅助存储器(辅存)、缓冲存储器

## 存储器性能

- 1)存储容量=存储字数x字长。存储字数表示存储器的地址空间大小即存储器的存储单元
数目，字长即存储字长，表示一次存取操作的数据量。
2)单位成本:每位价格=总成本/总容量。
3)存储速度:数据传输率=数据的宽度/存储周期。存储周期又称为读写周期或访问周期，
指连续两次独立地访问存储器操作之间所需的最小时间间隔。

## 层次化结构

- ![](assets/269418c5d0560e9e58592c9fcbe77b3e7013bf54509d08f122368dd3129fc7e2.png)
- ![](assets/5152034f2ec852638032a839853c092d8240ce1e3c5fbe520b95845042c01e6f.png)
- ![](assets/89c7cc6ee9e2c14eef1f5da126637407f6c979279fce0a6d0f20e66660ed64a4.png)

## 半导体随机存取存储器

- 译码的驱动方式

	- 线选法

		- 首先假设该矩阵有N行，然后就可以通过公式
【log2N 】算出地址线所需要的根数
		- ![](assets/d2f7327a12d829ff8ecd160f575c5de20515568bf3e96f1a0ed4b068d0084dfd.png)

	- 重合法

		- 矩阵中的定位元素的行列坐标需要行地址线也需要列地址线
		- ![](assets/074e63467b4e886c78d79a18bc782ab696bc8fc745431f1a1c524c928b7311a5.png)

- 静态存储器（SRAM)使用六管静态MOS存储单元电路，利用触发器保存信息，只要不断电，信息就不会丢失

	- 基本单元电路简图

		- ![](assets/081fecb50cb01ed25d64093a00754bd9863d76d2e3bd895df9483134f3e377ab.png)
		- ![](assets/63e397ee6c0813c19f52d33ea564bdfffb98a25bd6d3ea977b98dbd8625b33fb.png)
		- ![](assets/e4562d9ed6e5b2e4e99a39c19f5d9506b1ce03f1a73043ad7773b7662e8f098b.png)

	- 保持存储信息

		- ![](assets/8778b81f7e3ee9f538bfe8cc7c6c294bc5ed54a16406088a57b6b290e2e18f32.png)

	- 读数据

		- ![](assets/d80fea0aef12cd9833ddd8d5763673280d350f939173680249edc232df819343.png)
		- 读周期指对芯片两次连续读操作的最小时间间隔(tc);读时间表示进行一次存储器读操作的时间(ta)，显然读时间小于读周期。
![](assets/226c23e9909879e20f7e7c2a1289b06123249589cb08a740a375c797608fe2ab.png)

	- 写数据

		- ![](assets/347d917e8e34fd63c0abd90c76d7851b33282d1ddbbdfd7bc93d2ce58bf9c807.png)
		- 写周期指对芯片两次连续写操作的最小时间间隔(twc);写时间表示进行一次存储器写操作的时间(tw)，显然写时间小于写周期。
![](assets/454852e74872d8f88b53034bfb0246e0a770fc137d4c6b9490d647166787aca8.png)

- 动态存储器（DRAM)，利用MOS电容存储电荷来保存信息，需要不断给电容充电才能使信息来保存信息

	- 单管MOS的DRAM基本单元电路简图

		- ![](assets/a5b63b75dfc9a3c35f81dd4cc7cbefffd561f35a5f61710730264bd9604e38f3.png)

	- 保持存储信息

		- ![](assets/021107ab96f3254b5efed3aa9ce186a76754900cec7793c133aa77f79cfc8ac5.png)

	- 读数据

		- ![](assets/b0322bdaa2b79ae157e0f9bc2dac2a12553a84dba14a2277f6315f7c1476812d.png)

	- 写数据

		- ![](assets/be6f1a4ce2475b9612558640910d43e97a4c3e32cfa982185985d93772d91e57.png)

	- 刷新

		- 集中式

			- ![](assets/f9dd57be5471fd479d1049cb0802beddeee4a09d82216753c03822b12546fd5f.png)
			- ![](assets/81f55f65b311363478e4a5d9e0fe8c3812900abec25e8c3178bb4f8f6922dc20.png)

		- 分散式

			- ![](assets/22c3a422782729cfab735ed04bdbf56c0fda8920c567b8a3944f0851a0222aad.png)
			- ![](assets/bdf174bacf9917b527de5e20df655f3e7172604ab0dd97f2ee229c26e772de2b.png)

		- 异步刷新

			- ![](assets/b5760c298b430fd1615013ebef7bf8d780d8a79f85a2048009fcd91ce5847cf5.png)
			- ![](assets/96e31aca3504c95ddeb9327b91a6596527d1a5c7b299ed59ee08cf2a78527136.png)

## 存储器容量扩展

- 位扩展:用多个存储器芯片对字长进行扩充
- 字扩展:增加存储器中字的数量，提高存储器的寻址范围
- 字位扩展，假设一个存储器的容量为M×N位，若使用L×K位存储器芯片，那么，这个存储器共需要(M/L)×(N/K)个存储器芯片

## 双口RAM和多模块存储器

- 多体交叉存储器

	- 提高访存速度的方式

		- 采用高速器件
		- 采用层次结构
		- 调整主存结构

	- 计算机中大容量的主存可由多个存储体组成，每个存储体都具有自己的读写线路，地址寄存器和数据寄存器，称为"存储模块"。这种多模块存储器可以实现重叠与交叉存取
	- 第i个模块M的地址编号应按下式给出:M×j+i
	- 连续地址分布在相邻的不同模块内，而同一模块内的地址都是不连续的
	- ![](assets/2c63de4e5e22e5e563e3e176ddfaa07896c063c8e826cd6980aeb56a01bdffa6.png)
	- ![](assets/e797bc856e708e636c5a5c10a630bd17d319462eb6d874e6aebaa1af652de758.png)

- 双口RAM

	- 只要有写操作，就不能同时进行![](assets/bfeab74e58be3e15369a73264f8cd1e332ad61d366e68e701be86937815b212c.png)
	- ![](assets/1bd1c54ee701806d03ebdcb19a2810eb9b457f65b8111bb877cd785ed722eea5.png)

- 单体多字存储器

	- ![](assets/f0af23c22c1044c26dd0bb3d24cd504230f23f96307d5b9c65475bc50304f684.png)
	- 1、需要指令和数据在主存中必须连续存放
2、需要先把属于一个存储字的n个数据字读到数据寄存器中，等数据寄存器达到了一个存储字的长度，再将其写入存储器。

## 高速缓冲存储器

- cache的工作原理

	- 局部性原理，cache使用高速SRAM制作，主存一般是DRAM。
	- 主存地址和cache地址，两者的地址分为前m位寻找某个字块，剩下的n位查找该字块中的字或字节

		- cpu与cache传输数据的基本单位是字，主存和cache的基本单位是块。
		- CPU访问主存时，会将地址同时送给Cache和主存，Cache控制逻辑依据地址判断此
字是否在Cache中。若此字在Cache中，立即传送给CPU,否则，用主存读周期把此字从主
存读出并送到CPU。与此同时，把含有这个字的整个数据块，从主存读出并送到Cache中。

	- 块长

		- 块长一般取一个主存周期所能调出的信息长度（一般为16个字）

	- cache的容量和块的大小是影响cache的效率的重要因素
	- 命中率

		- CPU所要访问的信息是否在cache中的比率，而将所要访问的信息不在cache中的比率称为失败率
		- ![](assets/4fcd9e0a225e31278ccb8382742bb9252345bc845a4afb5f1aed10a04094eb00.png)

	- 一致性策略

		- 标志交换方式（写回法）
		- 通过式写入（写通法）
		- 写操作直接对主存进行，而不写入cache

	- cache的存取时间

		- 平均存取时间=h*tc+(1-h)(tc+tm) 

	- 最好替换策略

		- 按照被替换的字块是下一段时间最少使用的，由替换部件实现

- cache和主存的映射方式

	- 直接映像

		- ![](assets/badbaaae5d59a3637c23ecd8647757443a5e3343b412af412d4a57dae1ab2c28.png)
		- cache中许多空的位置被浪费
		- 主存地址：主存字块标记+cache字块地址+字块内地址

	- 全相联映像

		- ![](assets/e717cda534b3d31f6f32f100f3850258f795680188bb64cff6a60ca830fcc809.png)
		- 成本太高而不能采用
		- 主存地址：主存字块标记+字块内地址
		- 优点

			- 方式灵活，缩小了块发生冲突的概率

		- 缺点

			- 增加了标识位位数
			- 增加了寻找主存块在cache中对应块的时间

	- 组相联映像

		- ![](assets/4536c99fabf605db5a911ce17af6df5dd861955b5359e53e2cddd90c4729f172.png)
		- 直接映像和全相联映像的折衷
		- 主存地址：主存字块标记+组地址+块内地址

	- ![](assets/9587b412729929b1650afe58bfd6b5790b7f00dc7c43bb047d7eaf3a2c7e60ab.png)

- cache的主存块的替换算法

	- 先进先出算法（FIFO），没有用到访存的局部性原理，不能提高命中率
	- 近期最少使用（LRU），只记录每个块最近一次使用的时间。命中率提高
	- 随机法，没有用到访存的局部性原理，不能提高命中率

- 写操作策略

	- 写回法

		- cache的每行设置一个修改位（脏位），根据其值（0或1）进行修改；
写cache命中时，只修改cache内容，只有此行被换出时才写入主存，减少访问主存次数。

	- 全写法：当写cache命中时，cache和主存同时发生写修改。
	- 写一次法

		- 仅仅第一次写命中时同时写入主存，剩下的与写回法相同

## 虚拟存储器

- ![](assets/e5ce86fa724e55675d76303757bc19a094d94187e77807d265db226365ec8969.png)
- 页式虚拟存储器

	- 页式虚拟存储器就是将其基本单位划分为页，且将主存的物理空间划分为与虚拟存储器
等长的页。划分的页称为页面，主存的页称为实页，虚拟存储器的页称为虚页。
系统基本信息的传送单位是定长的页，需要通过地址变换机构实现访存过程，当访问页
面不在主存时，通过页面置换算法将需要的页面调入主存。
优点:由于页面的起点、终点地址是固定的，因此页表简单，调入方便，主存空间浪费
小。
缺点:由于页面不是逻辑上的独立实体，因此处理、保护和共享都不如段式虚拟存储器
方便。

- 段式虚拟存储器

	- 段式虚拟存储器是-种将主存按段分配的存储管理方式，各段的长度因程序而异。段是
利用程序的模块化性质，按照程序的逻辑结构划分成的多个相对独立部分。系统的基本信息
传送单位为段，并通过地址变换机构实现访存过程。
优点:段的分界与程序的自然分界相对应;段的逻辑独立性使它易于编译、管理、修改
和保护，也便于多道程序共享;某些类型的段(堆栈、队列)具有动态可变长度，允许自由
调度以便有效利用主存空间。
缺点:段的长度各不相同，段的起点和终点不定，给主存空间分配带来麻烦，而且容易
在段间留下许多空余的不易利用的零碎存储空间，造成浪费。

- 段页式虚拟存储器

	- 段页式虚拟存储器是段式虚拟存储器和页式虚拟存储器的结合。在这种方式中，把程序
按逻辑单位分段以后，再把每个段分成固定大小的页。程序对主存的调入/调出是按页面进行
的，但它又可以按段实现共享和保护。
优点:兼备页式虚拟存储器和段式虚拟存储器的优点。
缺点:在地址映射过程中需要多次查表。

- TLB（快表）

	- 页表分为快表和慢表，慢表在主存，快表在高速的虚拟存储器中，快表是慢表的一部分，快表命中，页表一定命中。同时命中可以确定页面调入内存，不能确定cache
	- 具有Cache并采用动态重定位存储管理的系统中，一次存储访问操作的过程

		- ![](assets/9718bfc9f0dec6489b67d4354c7dc78bcad76f094bc38b816c6a9a0acfb328df.png)
		- ![](assets/b68406a09c18f4f38b43cba180f3e54c0a8564bda04099c1d535f03d47c5b819.png)

- 访问关系

	- ![](assets/507e3f001cc33175b75178d30ca26ba8a14a67a1813acb526664dae7e44a5046.png)

- 缺失处理

	- ![](assets/3a6f52747ca168a9d77f3a782029ce587facbfe7a60453b05e6eb72c57dd584b.png)

## 外存储器

- 辅助存储器的技术指标

	- 存储密度

		- 定义：单位长度或单位面积磁层表面磁层所存储的二进制信息量
		- 道密度

			- 沿磁盘半径方向单位长度的磁道数称为道密度，单位为道/英寸tpi或道/毫米tpmm

		- 位密度或线密度

			- 单位长度磁道所能记录二进制信息的位数叫位密度或线密度，单位为位/英寸bpi或位/毫米bpmm

		- 每个磁道所存储的信息量是一样相等的

	- 存储容量

		- C = n × k × s
C为存储总容量; n为存放信息的盘面数; k 为每个盘面的磁道数; s为每条磁道上记录的二进制代码数。

	- 寻址时间

		- 平均寻址时间Ta=平均找道时间Ts+平均等待时间Tw =(最大寻道时间+最小寻道时间)/2+(最大等待时间+最小等待时间)/2
		- 辅存的速度

			- 寻址时间
			- 磁头读写时间

	- 数据传输率

		- Dr  = D × V

	- 误码率

- 硬盘存储器记录数据

	- 1)归零制(RZ)。记录“1”时，通正向脉冲电流;记录“0”时，通反向脉冲电流。“0”.和“1”信息之间驱动电流归零。
2)不归零制(NRZ)。记录“1”时，通正向脉冲电流;记录“0”时，通反向脉冲电流。只有当相邻信息代码不同时，电流才改变方向，故称为“见变就翻”。
3)“见1就翻”的不归零制(NRZ1)。 只有记录“1”时，电流才改变方向，
	- ![](assets/3cad5217cacfa596743709a6290cab86556d66e7e6dc19c31b2be893e48bc2c6.png)

- 硬磁盘存储器的类型

	- (1) 固定磁头和移动磁头
	- (2) 可换盘和固定盘

- 磁盘存储器

	- 磁盘存储器由驱动器（HDD），控制器（HDC）和盘片组成
	- 最外面的同心圆叫0磁道，最里面的同心圆假设称为n磁道
	- 驱动器的定位驱动系统实现快速精准的磁头定位
	- 主轴系统的作用是带动盘片按额定转速稳定旋转
	- 数据控制系统的作用是控制数据的写入和读出，包括寻址，磁头旋转，写电流控制，读出放大，数据分离
	- 磁盘控制器有两个方向的接口

		- 与主机的接口
		- 与驱动器（设备）的接口

- 磁盘阵列（RAID)

	- RAID是指多个小容量磁盘代替一个大容量磁盘，实现将数据分块并能并行处理
	- RAID0是简单的磁盘阵列架构，分块存储读取
	- RAID1是镜像备份

- 光盘

	- 采用光存储技术

		- 利用激光写入和读出
		- 第一代光存储技术

			- 采用非磁性介质

				- 不可擦写

		- 第二代光存储技术

			- 采用磁性介质

				- 可擦写

	- 光盘的存储原理

		- 只读型和只写一次型

			- 热作用（物理或化学变化）

		- 可擦写光盘

			- 热磁效应

# 第四章:指令系统

## 指令格式

- 结构(操作码+地址码)

	- 操作码：定长和不定长；位于每条指令的前一个字节或前多个字节
	- 操作数的地址
	- 操作结果的存储地址
	- 下一条指令的地址

- 地址码

	- 零地址指令

		- ![](assets/4b262834bbc24f823fff3f241a20ec3a6d623184546231338438f9577b96bb0e.png)

	- 一地址指令

		- 寻址范围  2^24 = 16 M

			- 2次访存

				- ![](assets/4850b016ce008539d3f7783f33047dfea27e70a869c89b3c3af245d7007677dc.png)

	- 二地址指令

		- 寻址范围  2^12 = 4 K

			- 4 次访存

				- ![](assets/abcee817f301d37d5a0aca5b966163ff1014b1d3d4469e23dd2f6faa7ede985d.png)
				- ![](assets/9bab287e80455dbfc7bd44115abe604142ab3466ce14415e10678d85f8e0554d.png)

	- 三地址指令

		- 寻址范围  2^8 = 256

			- 4 次访存

				- ![](assets/dac99ac6118d5449b7fc40adb90ac7a15f0b6de5746f80fe14285a40f59246dc.png)

	- 多地址指令

		- 寻址范围  2^6 = 64

			- 4 次访存

				- ![](assets/13c2334e9a46e2d245d3d2141935825aa4a8ab2a9747d4c65faadff08f0bf096.png)

- 指令字长

	- 取决因素

		- 操作码的长度
		- 操作数地址的长度
		- 操作数地址的个数

	- 指令字长 固定

		- 指令字长 = 存储字长

	- 指令字长 可变

		- 按字节的倍数变化

			- 1、不允许较短的操作码是较长操作码的前缀
2、各条指令的操作码一定不能重复

	- 对准边界存放

		- 不连续存放数据
		- 按字节编址

			- a.半字地址最低位恒为0
			-  b.字地址最低两位恒为0
			- c.双字地址的最低三位恒为0

		- 减少访存次数，浪费存储空间

	- 不 对 准 边 界 存 放

		- 连续存放数据
		- 节约存储器空间，但增加访存次数，对多字节数据存在调整高 低字节位置的问题

- 寻址方式

	- 数据寻址

		- ![](assets/1d450ce5c54b70adb3047fa97f827234274b3c9e98ee4e7b26b2e423b3668db1.png)
		- 分类

			- 立即寻址

				- ![](assets/33847282260e33f67c9fedad4dd3aa928eba39c93b256fdbdc4d38081d2392e1.png)
				- 优点:只需取出指令，便可立即获得操作数。采用立即寻址特征的指令只需在取指令时
访问存储器，而在执行阶段不必再访问存储器。
缺点:由于A表示的就是立即数，因此A的位数限制了立即数表示的范围
立即寻址方式通常用于对某寄存器或内存单元赋初值

			- 直接寻址

				- ![](assets/2c61bfdb07339c9a69a8e89e7f1d1b627614569fe94cc7fd3697bd10c17455fb.png)
				- 优点:寻找操作数非常简单，因为直接就给出了操作数的有效地址，而不需要经过某些
变换。
缺点:操作数的有效地址仅由A决定，而A的位数- -般都比较小,因此寻址范围比较小。
在执行阶段需要访问一次存储器去取操作数

			- 隐含寻址

				- ![](assets/e1d79b502dc3367b9ca72e1bbc2b31c9de713868a2a42d919256c15921e5497c.png)
				- 隐含寻址指指令字中不明显地给出操作数地址，其操作数地址隐含在操作码或者某个寄
存器中。

			- 间接寻址

				- ![](assets/090be6271d83101b8f2f6dbfe568d3667938c34ad1a6e2f1731dcf144d043971.png)
				- 优点:便于子程序返回和查表(
缺点:一次间接寻址在指令的执行阶段还需要访问两次存储器(-一次取操作数
的有效地址，一次取操作数)，而N次间接寻址却需要访问存储寻址特征器N+1次(前面N次找操作数的有效地址,第N+1次找操作数)。

			- 寄存器寻址

				- ![](assets/7f950f04ac1d1be380bb32d7b3d995fe0bd1321af08557a6112c1c79d4af0191.png)
				- 优点:
1)由于操作数在寄存器中，因此指令在执行阶段不需要访存，即减少了执行时间。
2)减少了指令字的长度

			- 寄存器间接寻址

				- ![](assets/16c9f5cce80ed901ce746c38476713a2a2e98f8d835e0ac8256348333eb5da91.png)
				- Ri的内容不是操作数,而是操作数所在主存单元的
地址号，即有效地址EA=(Ri)。
注意: XX寄存器名加了一个括号，表示此寄存器中的内容。
优点:便于编制循环程序。
缺点:寄存器间接寻址需要访问一次存储器去取操作数。

			- 基址寻址

				- ![](assets/42de2f3c348e6acb4e5b3aa610ffbc3a044cf0731792cddedf209fbcbf7182e0.png)
				- ![](assets/4a942fae38666954e5b620218fb8d3109a375a98099eaabb7ad3ba300b87faf5.png)
				- 优点:
1)扩大操作数的寻址范围(因为基址寄存器的位数可以大于形式地址A的位数)。只要对基地址寄存器的内容进行修改，就可以访问主存的任意单元。
2)便于解决多道程序问题，继续跳过，知道基址寻址可以用在多道程序即可。
注意:
1)基址寄存器的内容由操作系统确定，在程序执行过程中不能由用户随意改变!
2)虽然基址寄存器的内容不可以由用户改变，但是当采用通用寄存器组来作为基址寄存器时，用户有权知道到底使用了哪个通用寄存器来作为基址寄存器。

			- 变址寻址

				- ![](assets/6693cd06ccaa7d0c772580d7fb653c553db572ab26da651318a4cc8bb7c5e07e.png)
				- ![](assets/a130024ae110548c0558d92bddd3661f352d8c5096e7edba1b193795d8c1a6cc.png)

			- 相对寻址

				- ![](assets/4454ca3a42fe136b4e54c3bc3e3dad0f01d258e7cdf540b598fb67da61a0b6fa.png)

		- 寻址方式总结

			- ![](assets/0913e697e89d39c1e03945fd205a32d603ac0bbdecf3c0f418a302e348370987.png)

	- 指令寻址

		- ![](assets/cec180711579286e85bc505395a5b6be9958f9f1da5598aca38c67ab3794136a.png)

	- 标志寄存器与转移条件的逻辑表达式总结

		- ![](assets/894d65c2489dd154e6047a8ef0f5706f0e15be225c5a820b9fc56acedf701e74.png)

	- 操作数的存放地址

		- ![](assets/a5a9366b63243cf4028a4e41634fbba80501c5b421f9e0a9dec5dd5b8fa0726e.png)

- 指令操作码的扩展技术

	- 指令操作码的长度决定了指令系统中完成不同操作的指令数
	- 若某机器的操作码长度固定为K位，则它最多只能有2^K条不同指令
	- 指令操作码两种格式

		- 固定格式

			- 优点:对于简化硬件设计，减少指令译码时间非常有利
			- 缺点:指令少，浪费地址

		- 可变格式(分散地放在字的不同字段)

			- 优点:指令多，缩短指令平均长度，减少程序总位数，增加指令字所能表示的操作信息
			- 缺点:译码复杂，控制器的设计难度增大

	- 拓展方法的一个重要原则

		- 使用频度(即指令在程序中出现概率)高的指令应分配短的操作码，使用频度低的指令相应地分配较长的操作码

- 指令系统的兼容性

	- 保持系统向上兼容

## 精简指令系统计算机（RISC）——用于小型机

- 1)选取使用频率较高的一些简单指令以及一些很有用但又不复杂的指令，让复杂指令的
功能由使用频率高的简单指令的组合来实现。
2)指令长度固定，指令格式种类少，寻址方式种类少。
3)只有取数/存数指令访问存储器，其余指令的操作都在寄存器内完成。
4) CPU中有多个通用寄存器(比CISC的多)。
5)采用流水线技术(注意: RISC一定是采用流水线)，大部分指令在一个时钟周期内完
成。采用超标量和超流水线技术，可使每条指令的平均执行时间小于一个时钟周期。
6)控制器采用组合逻辑控制，不用微程序控制。
7)采用优化的编译程序。

## 复杂指令系统计算机（CISC）——用于大型机

- 1)指令系统复杂庞大，指令数目-般多达200~300条。
2)指令长度不固定，指令格式种类多，寻址方式种类多。
3)可以访存的指令不受限制(RISC 只有取数/存数指令访问存储器)。
4)由于80%的程序使用其20%的指令，因此CISC各指令的使用频率差距太大。
5)各种指令执行时间相差很大，大多数指令需多个时钟周期才能完成。
6)控制器大多数采用微程序控制。
7)难以用优化编译生成高效的目标代码程序。
- 1) RISC比CISC更能提高计算机的运算速度，由于RISC寄存器多，因此就可以减少访存次数;其次，由于指令数和寻址方式少，因此指令译码较快。
2) RISC比CISC更便于设计，可降低成本，提高可靠性。
3) RISC 能有效支持高级语言程序。

# 第五章：中央处理器

## 计算机工作过程

- 加电——》产生reset信号——》执行程序——》停机——》停电
- 产生reset信号的任务

	- 任务一：使计算机处于初始状态
	- 任务二：从PC中取出指令地址

- 控制器作用是协调并控制计算机各部件执行程序的指令序列

## CPU

- 功能分析

	- 1)控制器能自动地形成指令的地址，并能发出取指令的命令，将对应此地址的指令取到
控制器中，称为指令控制。
2)取到指令之后，应该产生完成每条指令所需要的控制命令，称为操作控制。
3)控制命令产生后，需要对各种控制命令加以时间上的控制，称为时间控制。
4)在执行的过程中，可能需要进行算术运算和逻辑运算，称为数据加工。
5)最后当然还有处理中断的能力，称为中断处理。
	- ![](assets/0a9c9de587ec7ade608fa1852f4f5a5d08c4bdc6715a453a769792f2a76bd846.png)

- 基本结构

	- 通过以上分析可知，指令控制、操作控制、时间控制由控制单元(CU)完成;数据加工
由ALU完成;中断处理由中断系统完成，最后再加上一些寄存器。
	- ![](assets/9ad49fe964ac5e5988f68fdff9308cbd9d2512aaa6351b9dff935daed4c56ad6.png)

## 相关寄存器

- 运算器中寄存器

	- ![](assets/acdc6340101153d16772e5667f757c25b64a29ba1e7b998049cfc5134de2a429.png)

- 控制器中寄存器

	- ![](assets/c6bc220347273c835e7f253c1ec770fabdc8b8d6f646f1f44c0be35a512c9a9e.png)

## 指令执行

- 指令周期

	- CPU每取出并执行一条指令所需的全部时间,即CPU完成一条指令的时间,称为指令周期。
指令周期被划分为几个不同的阶段，每个阶段所需的时间称为机器周期，又称为CPU工
作，周期或基本周期，通常等于取指时间(或访存时间)。时钟周期是时钟频率的倒数，也可称
为节拍脉冲或T周期，是处理操作最基本的单位。一 个指令周期由若干个机器周期组成，每
个机器周期又由若干个时钟周期组成。

		- ![](assets/8db44bb9258890594060288fef5aedf78c802de3a74f33f59ed0e1127783662d.png)

	- 当CPU采用中断方式实现主存与I/O交换信息时，CPU在每条指令的执行周期结束前，都要发出中断查询信号,以检测是否有I/O提出请求。如果有请求，则CPU要进入中断响应阶段，又称为中断周期。这样，一个完整的指令周期应包括取指、间址、执行和中断4个子周期，

		- ![](assets/08751d19076856ba61ea42c4b1e0ddb848fff42eeaaa322260a9bf032117b035.png)

- 执行方案

	- 1.单指令周期
对所有指令都选用相同的执行时间来完成，称为单指令周期方案。显然，此类方案中指
令周期的大小取决于执行时间最长的指令的执行时间，否则执行时间长的指令就不能在-一个
指令周期内执行完毕。因此，对于那些本来可以在更短的时间内完成的指令来说，其指令周
期被拉长了，整个系统的运行效率较低。
单指令周期方案的每一条指令都在固定的时钟周期内完成，指令之间串行执行，即下一
条指令只能在前一条指令执行结束之后才能启动。
2.多指令周期
对不同类型的指令选用不同的执行步骤来完成，称为多指令周期方案。
多指令周期方案的指令之间仍然串行执行，即下一条指令只能在前一-条指令执行结束之
后才能启动。但可以选用不同个数的时钟周期来完成不同指令的执行过程，指令需要几个周
期就为其分配几个周期，而不再要求所有指令占用相同的执行时间。
3.流水线方案
指令之间可以并行执行的方案，称为流水线方案。流水线方案的目标是力争在每个时钟
脉冲周期完成一条指令的执行过程(理想情况下)。通过在每一个时钟周期启动-条指令，尽
量让多条指令同时运行，但各自处在不同的执行步骤中。

- 执行过程

	- ![](assets/5c3fb501db1ca71709c5e463cbd6842c2a9d32b5fc9f61c0943defcb1ea260bd.png)

## 数据通路

- 功能和结构

	- ![](assets/1aff99c9fa3d328badbe53fb2b520e67d1bb73adaaafe25c06735d63bad41348.png)
	- ![](assets/32010f5ad4e23077c66ead49350ebcc8f886f2fb9eeaa4a26fb89fb84be2327c.png)

- 数据传达

	- ![](assets/cd9400904827ceb1323a16deef4cfdef81ecdeedf0c3d1f0e4ee30d51ce31c2b.png)
	- ![](assets/ac73610b8e52272127312bc9087449971a3c621e743b158372109a927fc555b0.png)

## 控制器的组成

- 控制器的功能

	- 取指令

		- 发出指令地址，取出指令的内容

	- 分析指令

		- （1）对操作码译码产生操作相应部件的控制信号
		- （2）根据寻址方式形成操作数地址

	- 执行指令

		- （1）根据分析指令后产生控制信号、操作数地址信号序列，通过CPU及输入输出设备的执行实现每条指令的功能
		- （2）结果回送存储器
		- （3）形成下条指令的地址

	- 控制程序和数据的输入和结果输出
	- 对异常情况和某些请求的处理

		- 异常情况的处理：例如算术运算的溢出、数据传送奇偶错
		- 某些请求的处理

			- “中断请求”信号
			- DMA请求信号

- 微操作命令

	- 执行周期

		- ![](assets/d219bf6486aaa61b7cafe406af9cf677677d34c2bc5b9e350eaa1c118e791c7b.png)
		- ![](assets/bb122be12191392732c8d26e703235999015f4c891d5690a88694322b0bd9335.png)

	- 中断周期

		- ![](assets/c7f0386019879eefc872a5aba02881f59efe14b60a6f32cfaec3ae0738000f6a.png)

- 控制单元功能

	- ![](assets/bc8cc2d744115f7dbd83c18d33edd7526227290dd9292f51ac78c41b26f03bb1.png)
	- 输入CU的内容如下:
1)指令寄存器。将指令的操作码送入CU进行译码。
2)标志。有时候控制单元需要根据上条指令的结果来产生相应的控制信号。因为“标志”也是控制单元的输入信号。
3)时钟。通过时钟脉冲来控制每个操作的执行时间和执行顺序。
4)来自系统控制总线的控制信号。中断请求、DMA请求等信号的输入。
输出CU的内容如下:
1) CPU内的控制信号。主要用于CPU内寄存器之间的传送和控制ALU实现不同的操作。
2)送至系统控制总线的信号。命令主存或者I/O读/写、中断响应等输出信号。
	- 示例一

		- ![](assets/1a03cc7f3b500b9ea3076ed6996b6e0926189cb9d54eba543cf9898d785f6e51.png)
		- ![](assets/626c3b870c41a060ee0750fa41ea1bac9ece32e99caa91c7944218bd8d15b809.png)
		- ![](assets/391c6b1a93042797b02bf4369224401ee52afdcf4e67f618d9513f546793c71a.png)

	- 示例二

		- ![](assets/ea3b61f7c2adef2bc3cdda69d84532ac2349536c5c4cdd2929c50be5ffcfe5be.png)

- 控制方式

	- 同步控制

		- 定长方式

			- 方案的特点是以最长的微操作序列
和最烦琐的微操作作为标准，采取完全统一 的、具有相同时间间隔和相同数目的节拍作为机
器周期来运行不同的指令
			- ![](assets/16ceb2b11da7e51ab839069d5d364a2e3f984554c686e595bf81e6887831e169.png)

		- 不定长方式

			- 方案每个机器周期内的节拍数可以不
等，有的指令微操作少，机器周期内只包含3个节拍。有的微指令操作复杂，则可以采用延长机器周期，即增加节拍的办法来解决。
			- ![](assets/414c1cd09683a7e89516fa1b694a966072b8ea491e635f1c794d61f501ef0d61.png)

		- 中央控制和局部控制结合

			- 方案将机器的大部分指令安排在统一
的、较短的机器周期内完成，称为中央控制，而将少数操作复杂的指令中的某些操作采用局
部控制方式来完成，如乘、除和浮点运算。
			- ![](assets/6c6aa6b05f61f475e179e851ad1890a5584c978775666b0bdd7fac91b2b2f2fa.png)

	- 异步控制

		- 异步控制方式不存在基准时标信号，没有固定的周期节拍和严格的时钟同步，执行每条
指令和每个操作需要多少时间就占用多少时间。这种方式微操作的时序由专门的应答线路控
制，即当CU发出执行某一-微操作的控制信号后，等待执行部件完成了该操作后发回“回答”
信号，再开始新的微操作，使CPU没有空闲状态，但因需要采用应答电路，故其结构比同步
控制方式复杂。
用途:异步控制-般用于主机与I/O设备间的传送控制，使高速的主机与慢速的I/O设
备可以按照各自的需要设置时序系统。

	- 联合控制

		- 联合控制方式是介于同步控制方式和异步控制方式之间的-一种折中方案，这种方式对各
种不同的指令的微操作大部分采用同步控制方式，小部分采用异步控制的方式。

- 控制单元设计

	- 组合逻辑控制（硬布线逻辑控制）

		- 由基本的门电路组合实现。这种方式实现的控制器的处理速度快，但电路庞杂，制造周期长，不灵活，可维护性差。
		- 硬布线控制单元

			- 1)经指令译码器译码产生的指令信息，一般为
指令的操作码字段进行译码后的输入信号。
2)时序系统产生的机器周期信号和节拍信号。
3)来自执行单元的反馈信息即标志。例如BAN
指令，控制单元要根据_上条指令的结果是否为负而产生不同的控制信号。

		- 硬布线控制器的微操作

			- ![](assets/a340ada80c6069f93b961731d310d3b8a13061d2797e2b09863fee08acb8bfae.png)
			- ![](assets/75b32a486cc5a85ebb4d023501d7e48dfb4df0cd4164fe7cd81fca6499c0fa37.png)

		- 设计步骤

			- 1)有些微操作的次序是不容改变的，故安排微操作节拍时必须注意微操作的先后顺
序。
2)凡是被控制对象不同的微操作，若能在-一个节拍内完成，则尽可能安排在同一个节拍.
内，以节省时间。
3)如果有些微操作所占的时间不长，则应该将它们安排在-一个节拍内完成，并且允许这
些微操作有先后次序。

	- 微程序控制

		- 仿照程序设计的方法编制每个机器指令对应的微程序，每个微程序由若干条微指令构成，各微指令包含若干条微命令。所有指令对应的微程序放在只读存储器中。当执行到某条指令时，取出对应微程序中的各条微指令，译码产生对应的微命令，送到机器相应的地方，控制其动作。这个只读存储器称为控制存储器(CS)。 微程序控制方式下，控制单元的设计简单，指令添加容易(灵活)，可维护性好，但速度较慢。
		- 涉及内容

			- 微命令与微操作

				- 一条 机器指令可以分解成-一个微操作序列，这些微操作是计算机中最基本的、不可再分
解的操作。在微程序控制的计算机中，将控制部件向执行部件发出的各种控制命令称为微命
令，它是构成控制序列的最小单位。微命令和微操作是-一对应的，微命令是微操作的控制
信号，微操作是微命令的执行过程。

			- 微指令与微周期

				- 微指令是若干微命令的集合。存放微指令的控制存储器的单元地址称为微地址。微指令
包含两大部分信息:
a.操作控制字段，又称微操作码字段，用于产生某一步操作所需的各种操作控制信号。
b.顺序控制字段，又称微地址字段，用于控制产生下一条要执行的微指令地址。
微周期指从控制存储器中读取条微指令并执行相应的微操作所需的时间。

			- 主存储器与控制存储器

				- 主存储器用于存放程序和数据，在CPU外部，用RAM实现;控制存储器(CM，简称控存)用于存放微程序，在CPU内部，用ROM实现。

			- 程序与微程序

				- 程序是指令的有序集合，用于完成特定的功能;微程序是微指令的有序集合，一条指令的功能由一段微程序来实现。

			- ![](assets/deda8a7aa503614d41a3b6b6f5ec66bb7b32f794e819f8a7addd0a1c5baff346.png)

		- 单元组成

			- 点画线框的输入是指令的操作码、时钟及
标志，其输出是至CPU内部和系统总线的控制信号。点画线框内的控制存储器(简称控存)
是微程序控制单元的核心部件，用来存放全部微程序;既然控存也看成存储器，肯定像主存
-样拥有属于自己的地址寄存器和数据寄存器，分别称为控制地址寄存器(CMAR)和控制
数据寄存器(CMDR)。控制地址寄存器用来存放欲读出的微指令地址;控制数据寄存器用来
存放从控存中读出的微指令;顺序逻辑用来控制微指令序列，其输入与微地址形成部件、微
指令的下条微指令的地址(简称下地址)段以及外来的标志有关。
			- ![](assets/bb43ce4c0158e565dd5ba109ed69dbb3b3294411da5624b1d495c0a87fd336e1.png)

		- 基本格式

			- 微指令的基本格式如图5-20所示，共分两个字段，-一个为操作控制字段，该字段发出各
种控制信号;另一个为顺序控制字段，该字段可指出下地址，以控制微指令序列的执行，这
个其实类似于PC。![](assets/ba16be03a752ef1757aa8591913d94fc0bedd6e5317140b97abfb31cd47fe3ce.png)

		- 编码方式

			- 直接编码（直接控制）

				- 在微指令的微命令字段中每一位都代表-一个微命令。设计微指令时，选用或不选用某个微命令，只要将表示该微命令的对应位设置成1或0就可以
了。因此，微命令的产生不需要译码直接编码的优点是简单、直观、执行速度快，操作并行性好。其缺点是微指令字长过长，造成控制存储器容量极大。![](assets/c01d7f755bfc213b5a06d954d1e1f2452f39a71e642cb22f2584c3a713d2d697.png)

			- 字段直接编码方式

				- 将微指令的微命令字段分成若干小字段，把互斥性微命令(在同一微指令周期中不能同时出现的微命令称为互斥性微命令)组合在同一字段中，把相容性微命令组合在不同的字段中。每个字段独立编码，每种编码代表一个微命令且各字段编码含义单独定义，与其他字段无关
这种方式可以缩短微指令字长，但因为要通过
译码电路后再发出微命令，所以比直接编码方式慢。
				- ![](assets/db4614bb93c2e4623f46da2b0f57cafc72127bbbe3de89a3a97fbc013051ae7f.png)
				- 分段原则

					- ①互斥性微命令分在同一字段内，相容性微命令分在不同字段中。
②每个小段中包含的信息位不能太多，否则将增加译码线路的复杂性和译码时间。
③一般每个小段还要留出一个状态，表示本字段不发出任何现行指令。因此，当某字段
的长度为3位时，最多只能表示7个互斥的微命令，通常用000表示不操作。

			- 字段间编码

				- 一个字段的某些微命令需由另一个字段中的某些微命令来解
释，由于不是靠字段直接译码发出的微命令，
故称为字段间接编码，又称为隐式编码。这种
方式可进-步缩短微指令字长，但因削弱了微
指令的并行控制能力
				- ![](assets/7d33c4912969aa68466f379c36b702eb748102c45f377af15dd814b0f402dccb.png)

			- 混合编码

				- 混合编码方式由直接编码与字段(直接或间接)编码混合使用。

		- 微指令的序列地址

			- 后续微指令的地址可以由微指令的下地址字段直接给出，这种方式又称为断定方式
			- 后续微指令的地址还可以根据机器指令的操作码形成。微地址形成部件实际是一个编码器，其输入为指令操作码。即将机器指令的操作码送入地址译码器进行译码，输出结果就是对应该机器指令微程序的首地址。然后拿着首地址去微命令寄存器找到相应的微命令。
			- 其他方式

				- 增量计数器法

					- 通常来讲，后续微指令的地址是连续的，因此对应顺序地址，和PC一样通过自增来形成下一条微指令的地址，即(CMAR) +1→CMAR。

				- 分支转移

					- 和机器指令的执行一-样，不可能一直都是 顺序执行。当遇到条件转移指令时，微指令就会出现分支，这样就必须根据各种标志决定下一条微指令的地址。![](assets/59fb2bff5b4edc216f258884e798b50b7f0f4ebcb175c911044d7a0d7a90bc21.png)
					- 其中，转移方式指明判别条件(如果结果小于0，就转移;否则，顺序执行)，转移地址
指明转移成功后的去向，若不成功，则顺序执行。有的转移微指令中设两个转移地址，条件
满足时选择其中一个转移地址;条件不满足时选择另一个转移地址。

				- 硬件产生微程序的入口地址

					- 子主题 1

		- 微指令格式

			- ![](assets/1e2f25e55c53c4d2f629e4484c74503fbf312ec4fe62f16f1c6acca475f878c5.png)

		- 微操作的节拍和安排设计步骤

			- ![](assets/203ade31839e5c80601ce4adb161be3d59b54fc337d45b1ffe665722edaa4d4d.png)

## 指令流水线

- 当第N-2条指令在执行的时候应该对第N-1条指令进行译码，当第N-1条指令在译码
时，可以将第N条指令取出来，这样就缩短了每条指令的平均执行周期。![](assets/acd37bf67cdd3ead10bc445751fdc351cf638cdf0015a42b7f7f1129ff858e2a.png)
- 基本实现

	- 资源（结构）相关

		- 所谓资源相关是指多条指令进入流水线后在同一机器时钟周期使用了同一个功能部件所
发生的冲突。假定一条指令流水线由5段组成，分别为取指令(FI); 指令译码(ID)、计算
有效地址或执行(EX)、访存取数(MEM)和结果写寄存器(WB)。
		- ![](assets/e8306d6c98d1219fa260d17ec2cbc5df1cf35033d89efe22e03e94719bad6283.png)
		- 解决方案

			- 第L4条的FI段停顿一个时钟再启动
			- 增加一个存储器，将指令和数据分别放在两个存储器中。

	- 数据相关

		- 在一个程序中，如果必须等前-条指令执行完毕后，才能执行后一条指令，那么这两条
指令就是数据相关的。
		- 写后读相关

			- 字面理解就是应该先写入再读取，而现在是没有写入就已经读了(即读了旧数据)，出现
错误。

		- 读后写相关

			- 字面理解就是应该先读取再写入，而现在是写入后再读取(本来应读取旧数据，现在却
读到了新数据)，出现错误。

		- 写后写相关

			- 字面.上理解是前面一条指令先写数据，然后后面一条指令再写，而现在恰好相反了，导致数据错误

		- 解决方案

			- 最简单的方式就是使读操作延后，直到数据写入再去读。但是一般使用数据
旁路技术来解决数据相关。
数据旁路技术:设置相关专用通路，即不等前一条指令把计算结果写回寄存器组，
而是直接把前一条指令的计算结果作为输入数据给下一条需要此结果的指令(下-条指
令不再读寄存器组),使本来需要暂停的操作变得可以继续执行。

	- 控制相关

		- 控制相关冲突是由转移指令引起的。当执行转移指令时，依据转移条件的产生结果，可
能顺序执行下一条指令;也可能转移到新的目标地址取指令，从而使流水线发生断流。
		- 解决方案

			- 采用“猜测法”技术，机器先选定转移分支中的一个，按它取指并处理，条件码生成后，如果猜测正确，那么流水线继续进行下去;如果猜测错误，那么之前预取的指令失效。

- 性能指标

	- ![](assets/8f249071b56d1220f6b4cfe30312cfc34a6d69edf837919f1b896a668f18bf37.png)

## 超标量与动态流水线概念

- 超标量技术

	- 超标量技术的每个时钟周期不像以前的
普通指令流水线只能执行一条指令的某个阶
段，而是可以并发执行多条独立指令，为此
就需要配置多个功能部件，如图5-30所示。

- 超级流水线

	- 典型的流水线是将每一条机器 指令分成
5步，即取指、译码、取操作数、执行和回写。在理想条件下，平均每个时钟周期可以完成一条指令。 而所谓的超级流水线是将机器指令划
分为更多级的操作，以减轻每一-级的复杂程度。 在流水线的每一步中， 如果需要执行的逻辑操作少-一些，那么每一步就可以在较短的时间内完成

- 超长指令字

	- 由编译程序挖掘出指令潜在的并行性，将多条能并行操作的指令组合成-条具有多个操
作码字段的超长指令字(可达几百位)，为此需要采用多个处理部件。

- 动态流水

	- 动态流水线就是多种运算可以同时进行，而静态流水线只能是一-种运算进行完再进行下
一种运算。

## 中断系统

- 过程分析

	- 当CPU执行完--条现行指令时，如果外部设备向CPU发出中断请求，那么CPU
在满足响应条件的情况下，将发出中断响应信号，与此同时关闭中断(“中断屏蔽”触发器置
“1"),表示CPU不再受理另外一个设备的中断。这时,CPU将寻找中断请求源是哪一个设备，
并保存CPU. 自己的程序计数器(PC)的内容。然后，它将转移到处理该中断源的中断服务
程序。CPU在保存现场信息、设备服务( 如交换数据)以后，将恢复现场信息。这些动作完
成以后，开放中断(“中断屏蔽”触发器置“0”)，并返回到原来被中断的主程序的下一条指令。
	- ![](assets/a83f896909afcccd804b90934c5d03d2f629e16bce053c9d8d6c1892eb481bb0.png)
	- 提出中断请求

		- 多个触发器就可以组成-一个多位中断请求标记寄存器。
一个中断系统，在任何时刻只能响应一个中断源请求。![](assets/042ca6a27f47272bbe1f967b2b73ccb11b27548ffd056c56147b127d8f8887a9.png)
		- 中断响应优先级是由硬件排队线路或中断查询程序的查询顺序决定的，不可动态改变;而中断处理优先级可以由中断屏蔽字来改变，反映的是正在处理的中断是否比新发生的中断的处理优先级低(屏蔽位为“0”，对新中断开放),如果是的话,
就中止正在处理的中断，转到新中断去处理，处理完后回到原被中止的中断继续处理。

			- 硬件实现

				- ![](assets/f896b06f02ebbb3d7ad8e67c223f1ac03ff1ca6985432c861e9a998a3661f27b.png)

			- 软件实现

				- ![](assets/346990f9cdfadd12d58d7c187ace0bcb7433d213eee8d1a53b06f25f0ea140c6.png)

		- 中断服务程序入口地址

			- 硬件向量法

				- 硬件向量法就是利用硬件产生中断向量地址(可简称为向量地址)，再由向量地址找到中断服务程序入口地址。而向量地址是由中断向量地址形成部件产生的。
①第一种方法很简单，当CPU响应中断时，只要将向量地址(如12H，见图5-38)送
至PC,执行这条指令，便可无条件地转向某服务程序的入口地址200。
②第二种方法就是设置向量地址表，如图5-38 所示。该表存放在存储单元内，存储单
元的地址为向量地址，存储单元的内容为中断服务程序入口地址，即中断向量。只要访问向
量地址所指示的存储单元，便可获得入口地址。
				- 中断向量是中断服务程序入口地址，而中断向量地址是中断服务程序入口地址的地址

			- 软件查询法

				- 用软件寻找中断服务程序入口地址的方法称为软件查询法，当查询到某一中断请求时，接着安排一条转移指令， 直接指向此中断源的中断服务程序入口地址，机器便能自动进入中断处理。至于各中断源对应的入口地址，则由程序员(或系统)事先确定。

	- 响应中断

		- 条件

			- 一个关中断的操作，或者称为允许中断触发器
EINT,它可被开中断指令置“1”，也可被关中断指令置“0”。当允许中断触发器为“1”时，
意味着CPU允许响应中断源的请求;当其为“0”时，意味着CPU禁止响应中断。所以，CPU
必须要满足如下条件才响应中断，即当EINT=1，且有中断请求时，CPU才可以响应中断。

		- 时候

			- CPU总是在指令执行周期结束后，才会去查询是否有中断。如果有，则进入中断周期;如果没有，则进行下一条指令的取指周期。

		- 方式

			- CPU要响应中断，就必须进入中断周期，一旦进入中断周期，即由中断隐指令(硬件自动)完成下列操作；中断隐指令不属于系统指令，它是CPU在中断周期内由硬件自动完成的一条指令。

				- 保护程序断点

					- 将当前程序计数器(PC) 的内容保存到存储器中。
它可以存在存储器的特定单元内，也可以存入堆栈

				- 寻找中断服务程序入口地址送至pc
				- 关中断

					- CPU进入中断周期意味着CPU响应了某个中断源的请求，为了确保CPU响应该中断后所做的一-系列操作不至于再受到新的中断请求的干扰，在该中断周期内必须自动关中断，以禁止CPU再次响应新的中断请求。

	- 保存断点和保存现场

		- 断点是中断返回时被中断程序继续执行处指令的地址(即响应中断时PC的值)
和当时的程序状态字(PSW)的内容，所以必须在进入中断处理前先保存到栈中;否则，当
取来中断服务程序的首地址送PC后，原断点PC的值就被破坏了。而现场是被中断的原程序
在断点处各个寄存器的值，只要在这些寄存器再被使用前保存到栈中就行了，在实际处理中
断事件过程中可能要用到这些寄存器，所以在实际处理之前的准备阶段来保存现场(寄存器
压栈)，而在实际处理后的结束阶段再恢复现场(寄存器出栈，恢复到中断处理之前)。
程序断点的保护由中断隐指令完成，CPU内部各寄存器内容的保护在中断服务程序中
由用户(或系统)用机器指令编程实现。

	- 中断处理过程中的新中断处理

		- 单重中断

			- 待执行完当前服务程序在响应新中断

		- 多重中断（中断嵌套）

			- 条件

				- 提前设置“开中断”指令码
				- 优先级别的中断源有权中断优先级的中断源。采用屏蔽技术

			- 屏蔽技术

				- 每个中断请求触发器都有一个屏蔽触发器，将所有屏蔽触发器组合在一起，便构成了一个屏蔽寄存器。屏蔽寄存器的内容称为屏蔽字(又称为屏蔽码)。每个中断源都对应一个屏蔽字；
				- 设置屏蔽字的指令必须在开中断指令之前
				- ![](assets/5421d7ebce85dfe38256f13c892ba058be59205e9245219e502b09265abddc61.png)

		- ![](assets/0d711b07e74bf1e5634e38c2e764364cec4c4c956aa3f926ec5262e4c9b953dc.png)

# 第六章  总线

## 基本概念

- 采用总线结构，增减外部设备变得非常轻松。总线是连接多个部件的信息传输线，是各部件共享的传输介质。。
分时是指同一时刻只允许有-一个部件向总线发送信息。如果系统中有多个部件，则它们只能分时地向总线发送信息。
共享是指总线上可以挂载多个部件，各个部件之间互相交换的信息都可以通过这组线路
分时共享。同一时刻只允许有一个部件向总线发送信息，但多个部件可以同时从总线上接收
信息。

	- ![](assets/033c992080e1517606dd38d67b0cdb6c1858c4132074e2191e9ef8ebc0a57598.png)

- 传输周期

	- 指CPU通过总线对存储器或IO端口进行一次访问所需的时间，
包括总线申请阶段、寻址阶段、传输阶段和结束阶段

- 传输宽度

	- 总线实际上是由许多传输线或通路组成的，每条线可一位一位地传输二进
制代码，一串二进制代码可在一段时间内逐一 传输完成。 若干条传输线可以同时传输若干位
二进制代码

## 分类

- 数据传送方式

	- 并行传输总线和串行传输总线

- 使用范围

	- 计算机总线和测控总线

- 连接部件

	- 片内总线

		- 芯片内部总数

	- 系统总线

		- 数据总线

			- 用来传送各功能部件之间的数据信息，它是双向传输总线。数据总线的位数称为数据总线宽度。如果数据总线的位数为8位，而指令字长为16位，那么CPU在取指令阶段必须进行两次访问。

		- 地址总线

			- 是单向传输总线。地址总线主要用来指出数据总线上的源数据或目的数据在主存单元的地址或IO设备的地址，地址总线上的代码
用来指明CPU欲访问的存储单元或I/O设备的地址，由CPU给出。

		- 控制总线

			- 控制总线使各部件能在不同时刻占有总线使用权，用来发出各种控制信号的传输线。

	- 通讯总线

		- 通信总线:用于计算机系统之间或计算机系统与其他系统之间的通信。通信总线按照数
据传输方式可分为串行通信和并行通信。一般来说，并行通信适合近距离的数据传输，通常小于30m;串行通信适宜于远距离传送。

## 组成和性能指标

- 总线通常由一组控制线、- -组数据线和一组地址线组成。但是也有例外，某些总线没有单独的地址线，地址信息也通过数据线来传送，这种情况称为数据线和地址线复用。
- 性能指标

	- 总线宽度

		- 指数据总线的根数

	- 总线带宽

		- 单位时间内总线上传输数据的位数
总线的工作频率是一秒可进行总线传输次数。时钟频率表示每秒有多少个时钟周期。

## 总线结构

- 单总线结构

	- 单总线结构是将CPU、主存、IO设备(通过I/O接口)都连接在- -组总线上，允许I/O
设备之间、IO设备与CPU之间或I/O设备与主存之间直接交换信息，这种总线结构简单，很容易扩充外部设备。但是缺点也是显而易见的，所有的信息传送都通过这组共享总线，即不允许两个以上的部件在同一时刻向总线传输信息，这就必然会影响系统的工作效率。所以，这类总线多数被小型计算机或微型计算机采用。另外，使用
单总线结构肯定不能解决CPU、主存、IO设备之间传输速率不匹配问题，故必须使用多总
线结构。

单总线的特点:由于I/O设备与主存共用一组地址线，因此主存和I/O设备是统-编址
的，CPU就可以像访问内存一样访问外部设备。

- 双总线结构

	- 双总线的结构特点是将速度较低的I/O设备从单总线中分离出来，形成主存总线与I/O
总线分开的结构。，每次主存和I/O设备交换信息都要经过CPU,那CPU的工作效率就自然会降低。
	- ![](assets/47f28c7dbc88dc43e6783b4244e6e5e388551708baae4d4e1b5fe71e9e310259.png)

- 三总线结构

	- 三总线结构增加了一条小路
(DMA总线)，专门用于I/O高速设备.
与主存之间直接交换信息。
注意:在三总线结构中，任意时刻只能使用一种总线。主存总线与DMA总线不能同时对主存进行存取，IO总线只有在CPU执行I/O指令时才能用到
	- ![](assets/23957ae32f24b03ec6ca1631fd0674225e871a0f44ad97946bb74ded002c71c8.png)

## 总线仲裁

- 实现以某种方式选择一个主设备优先获得总线控制权
- 集中仲裁

	- 总线上所连接的各类设备，按其对总线有无控制功能可分为主设备和从设备。主设备对总线有控制权，从设备只能响应从主设备发来的总线命令，对总线没有控制权。总线上信息的传送是由主设备启动的，如某个主设备欲与另一个设备进行通信时，首先由主设备发出总线请求信号，若多个主设备同时要使用总线时，就由总线控制器的判优、仲裁逻辑按一定的优先等级顺序确定哪个主设备能使用总线。只有获得总线使用权的主设备才能开始传送数据。

一根总线可以连接在若干设备上，在这些设备中，有一个或多个主控设备。在某一个总线传输周期内，一根总线只能有一个主控设备控制总线，选择一个从设备与之进行通信。

		- 链式查询

			- 在链式查询中，总线上的所有部件共用一根总线
请求线，当有部件请求使用总线时，均需要经此线发总线请求到总线控制器。由总线控制器检查总线是否忙，若总线不忙，则立即发总线响应信号，经总线同意线(BG)串行地从一个部件送到下一个部件，依次查询。若响应信号到达的部件无总线请求，则该信号立即传送到下-一个部件;
若响应信号到达的部件有总线请求，则信号被劫持，不再继续传下去。

链式查询优先级判别方式:离总线控制器越近的部件，其优先级越高;离总线控制器越远的部件，其优先级越低。
链式查询的优点:只需要3根控制线就能按一定的优先级实现总线控制，结构简单，易扩充。
链式查询的缺点:
1)对硬件电路的故障敏感，也就是说，如果第i个设备的接口电路有故障，则第i个设备以后的设备都不能进行工作。
2)当优先级高的部件频繁请求使用总线时，会使优先级较低的部件长期不能使用总线。
			- ![](assets/75fe94bbd64adfdfad45317c3e714ea94144ae7884f414e2760b9c368d9008de.png)

		- 计数器查询

			- 计数器定时查询方式采用一个计数器控制总线使用权(计数器在总线控制部件里面)。相对于链式查询方式多了一组设备地址线，少了一根总线同意线。各个设备仍共用一条请求线。
计数器查询优先级判别方式:当总线控制器收到总线请求信号判断总线不忙时，计数器
开始计数，计数值通过一组地址线发向各个部件。当地址线上的计数值与请求使用总线设备的地址一致时，该设备获得总线控制权。同时，终止计数器的计数及查询工作。
			- 计数器有两种计数方式:①计数器每次判优都从“0”开始，此时一- 旦设备的优先顺序
被固定后，设备的优先级就按0，1, 2，... n的顺序降序排列，永远不能改变;②计数器
也可以从上一次的终点开始计数，即是一种循环方法，此时所有设备使用总线的优先级相等。
计数器的初值当然也可以由程序设置，故优先级顺序可以改变。

计数器查询方式的优点:各设备的优先级顺序可以改变，且对电路的故障不如链式查询
方式敏感。
计数器查询方式的缺点:增加了控制线数(少了一根总线同意线，多了log2n 根设备地
址线)，控制也比链式查询复杂。
			- ![](assets/e4dcad2b5c5258293da8e1b9a14bf8376ed590087e25781aa8e1a2609fc4b3dd.png)

		- 独立请求

			- 每一个设备均有一对总线请求信号BRi和总线同意信号BGi。
独立请求优先级判别方式:当总线上的部件需要使用总线时，经各自的总线请求线发送总线请求信号，在总线控制器中排队(总线控制部件中有一个排队器)。当总线控制器按一定的优先顺序决定批准某个部件的请求时，则给该部件发送总线响应信号，该部件接到此信号就获得了总线使用权，开始传输数据。

独立请求方式的优点:响应时间很快(以增加控制线数为代价)，对优先级顺序的控制相
当灵活(也可通过程序来改变)。
独立请求方式的缺点:控制线数量多(n 个设备需要2n+1根控制线)，总线控制更复杂。
			- ![](assets/82e764ddac2fd8390d9eb6237decd127df6f0e6309e844347dcabdd96b5f80bf.png)

- 分布仲裁

	- 分布仲裁方式不需要中央仲裁器，每个主模块都有自己的仲裁号和仲裁器，多个仲裁器竞争使用总线。当它们有总线请求时，把它们各自唯--的仲裁号发送到共享的仲裁总线上，每个仲裁器将从仲裁总线上得到的仲裁号与自己的仲裁号进行比较。若仲裁总线上的号优先级高，则它的总线请求不予响应，并撤销它的仲裁号。最后，获胜者的仲裁号保留在仲裁总线上。

## 总线操作和定时

- 总线周期

	- 申请分配

		- 由需要使用总线的主模块(或主设备)提出申请，经总线仲裁机器决定下一个传输周期的总线使用权授予某-一申请者。

	- 寻址阶段

		- 取得了使用权的主模块通过总线发出本次要访问的从模块(或从设备)的地址及有关命令，启动参与本次传输的从模块。

	- 传达数据

		- 主模块和从模块进行数据交换，数据由源模块发出，经数据总线流入目的模块。

	- 结束阶段

		- 主模块的有关信息均从系统总线上撤除，让出总线使用权。

- 总线通信控制
总线传输周期开始计时的前提是主设备已得到总线控制

	- 同时定时

		- 同步定时方式指系统采用一个统一的时钟信号来协调发送和接收双方的传送定时关系。
时钟信号通常由CPU的总线控制器部件发出，然后送到总线上的所有部件。
不管输入输出，地址信号一定是全程陪伴
		- ![](assets/16b909a57da199c371b4b1358212fa2b50d4863ec6bfaae78aa7f41bcc8bb674.png)

			- ![](assets/0518bf86232095bc7cf1620589026ad5be5ced67be6937142436e8661f143ca7.png)

		- ![](assets/54d5c427ae331100870c1d90d39fb2c3611810402eb5f24b2bc892c14d529ab5.png)

			- ![](assets/fc941d36715615a4685e5509e29db0ef3f989e03edfda73ff16877fd5da952d4.png)

		- 同步通信的优点:传送速度快，具有较高的传输速率。
同步通信的缺点:同步通信必须按最慢的模块来设计公共时钟，当总线上的模块存取速
度差别很大时，便会大大损失总线效率，并且不知道被访问的外部设备是否真正响应，故可
靠性较低。
同步通信的使用范围:总线长度较短、总线所接部件的存取时间应该都比较接近。

	- 异步定时

		- 同步通信一般都是在各模块速度一致的情况下使用， 不一致会造成效率大大降低，为了
克服同步通信的这一缺点，异步通信允许各模块的速度不-致。异步通信没有公共的时钟标
准，不要求所有部件严格地统一 操作时间，而是采用应答的方式(或称握手方式)，即当主模
块发出请求信号时，- -直等待从模块反馈“响应”信号后才开始通信。当然，这就要求主、
从模块之间增加两条应答线。
		- ![](assets/69ad89d04fa16551c670951ff04670e7e3c40ec055f88b500723cac26cf205dd.png)
		- 不互锁

			- 特点:主模块的请求信号和从模块的回答信号没有互相的制约关系。即主模块发出请求
信号后，不必等待接到从模块的回答信号，而是经过一段时间， 默认从模块已收到请求信号
后，便撤销其请求信号;从模块接到请求信号后，在条件允许时发出回答信号，并且经过一
段时间(这段时间的设置对不同设备而言是不同的)也默认主模块已收到回答信号后，自动
撤销回答信号。主模块的请求信号发出，后面没有任何的确认信号。

		- 半互锁

			- 特点:主模块的请求信号和从模块的回答信号有简单的制约关系。即主模块发出请求信
号后，必须接到从模块的回答信号后才撤销请求信号，有互锁的关系。而从模块接到请求信号后，发出回答信号，但不必等待获知主模块的请求信号已经撤销，而是隔一段时间自动撤
销回答信号，不存在互锁关系。主模块的请求信号发出，需要等到从设备发出回答信号;而从模块发出回答信号后，不需要再等待主模块的确认信号

		- 全互锁

			- 特点:主模块的请求信号和从模块的回答信号有完全的制约关系。_即主模块发出请求信
号后，必须等待从模块回答后才撤销请求信号;从模块发出回答信号也必须等待收到主模块
的应答信号才撤销其回答信号。主模块的请求信号发出，需要等待从设备发出回答信号;而从模块发出回答信号后，也要再次等待主模块的回答信号。

	- 半同步通信
	- 分离式通信

## 总线标准

- 系统总线标准

	- 1) ISA。 工业标准体系结构总线(ISA) 是最早出现的微型计算机的系统总线标准，应
用在IBM的AT机上。.
2) EISA。扩展的ISA总线(EISA),是为配合32位CPU而设计的总线扩展标准，EISA
对ISA完全兼容。
3) VESA (VL-BUS)。VESA局部总线标准是-一个32位标准的计算机局部总线，是针对
多媒体PC要求高速传送活动图像的大量数据应运而生的。
4) PCI (最常用)。PCI局部总线是高性能的32位或64位总线，是为高度集成的外围部
件、扩充查办和处理器/存储器系统而设计的互连机制，支持即插即用并且可对数据和地址进
行奇偶校验。
5) PCI-Express (PCI-E)。 PCI-Express 是最新的总线和接口标准，这个标准将全面取代
现行的PCI和AGP，最终实现总线标准的统一。

- 设备总线标准

	- 1) IDE。集成设备电路(IDE)是- -种IDE接口磁盘驱动器接口类型，用于处理器和磁盘驱动器之间。
2) AGP。加速图形接口(AGP) 是一种视频接口标准，专用于连接主存和图形存储器。
3) USB接口。可实现外部设备的快速连接。
4) SATA. 串行高级技术附件(SATA) 是一-种基于行业标准的串行硬件驱动器接口，是
由Intel、 IBM、 Dell、 APT、Maxtor和Seagate公司共同提出的硬盘接口规范。

# 第7章   输入和输出系统

## 输入输出的发展

- 程序查询方式

	- ![](assets/b2beda3a4eb53ef39b53411df766331e8a634417ef16ca6c685db7cea7acf354.png)

- 中断方式和DMA方式

	- ![](assets/3dbcc72d81bced463827e2ca6e65a3e7cedd3b97dcdc690066afbaef9bfb571f.png)
	- ![](assets/75b196d2a029f82e72e2f4cac5496c94e8d856379234a40297d1a744fe1b49b3.png)

- 通道结构阶段

	- ![](assets/f600c36865988fa08f128ebacab4ede3be2ea3ec9957d1f2c64a883aa1e44279.png)

- I/O处理器阶段

## I/O系统基本概念

- I/O软件

	- I/O软件的主要功能:将用户编制的程序输入主机内，将运算结果输出给用户，实现输
入/输出系统与主机工作的协调。
对于采用接口模块方式，要使得I/O设备与主机协调工作，必须靠I/O指令来完成。对
于采用通道管理方式，不仅需要I/O指令，还需要通道指令。

		- I/O指令![](assets/ade203ff91ecec2d77079c5a315b2e2b967c4287e919bd756a1b3319c1cfb875.png)
		- 通道指令

			- 通道指令又称为通道控制字，它是通道用于执行I/O操作的指令，可以由
管理程序存放在主存的任何地方(通道指令存放在主存里面)，由通道从主存中取出并执行。
通道程序由通道指令组成，它完成某种外部设备与主存之间传送信息的操作

		- 通道指令是通道的自身指令(不属于CPU指令系统)，用来执行I/O操作。而I/O指令属于CPU指令系统的一部分，是CPU用来控制输入/输出操作的指令，由CPU译码后执行。具有通道指令的计算机，一旦CPU执行了启动IO设备的指令，就由通道来代替CPU对I/O设备的管理。

- I/O硬件

	- 输入/输出系统的硬件组成是多种多样的，在带接口的I/O系统中，I/O 硬件包括接口模
块和I/O设备两大部分;在具有通道或I/O处理器的I/O系统中，I/O 硬件包括通道(或称为
处理器)、设备控制器和I/O设备等。

## 设备分类

- 输入设备

	- 键盘

		- 详细过程:先对键盘的每个键进行编号，将每个编号和一个ASCII码进行对应，并放在
ROM中。由译码器对键盘进行扫描，一且扫描到有键按下，就可以马上得到此键的编号，然
后将此编号和ROM进行比较，就可以得到对应编号的ASCII码值，然后将此ASCII码值传
给计算机。

	- 鼠标

		- ![](assets/76898b756d46c4cd22be411206c1155567783a2dd4da6b4dc39a634db4cf3e87.png)

- 输出设备

	- ![](assets/50ca5019967f99d912a8542ee8cbb3a3ff8ccf68e84abf14f5344a3e02b4c87e.png)
	- ![](assets/9fdb16093eb69a8a1d9d822f983617e7f4eefd86189ab387488c20b5361d0c5e.png)

## I/O接口

- I/O接口和I/O端口关系

	- I/O 接口和I/O端口是两个不同的概念，但相互之间有关联。I/O 接口是主机和外设之间传送信息的“桥梁”，介于主机和外设之间。主机控制外设的命令信息、传送给外设的数据或从外设取来的数据、外设送给主机的状态信息等都要先存放到IO接口中。所以接口中有一-些寄存器，用于存放这些命令、数据和状态信息。把I/O接口中的这些寄存器称为I/O端口。

- 功能和基本结构

	- 功能

		- ![](assets/b5795a0f9f7026811163719841dbc365dea4ebdf1b56004bb235cc6d6476137a.png)

	- 系统总线组成

		- 数据线(双向):用作I/O设备与主机之间传送数据
设备选择线(单向);用来传送设备码。
命令线(单向):用来传输CPU向设备发出
的各种命令信号，如启动、停止、读、写等信号。
状态线(单向):将I/O设备的状态向主机报
告的信号线。

			- ![](assets/35e54b3a343a579be9dd7e10bb27d5705d2ae435fcc73204a293fe539f7e2c12.png)

	- 功能

		- 选择设备

			- 由于I/O总线与所有设备的接口电路相连，
但CPU究竟选择哪台设备，还得通过设备选择线
.上的设备码来确定，该设备码将送至所有设备的
接口，因此当设备选择线上的设备码与本设备码
相符合时，应发出设备选择信号SEL,这种功能
可通过接口内的设备选择电路来实现。设备选择电路可从设备选择线上得到设备
码，若和本设备码相符合，则SEL信号有效，即
有输出。那么此信号便可控制这个设备通过命令
线、状态线和数据线与主机交换信息。

				- ![](assets/6ec3bef646ca3eaf174f25d7638805753c6cf1b27f29f43cb4dd788810ccb01a.png)

		- 传送命令

			- 当CPU向I/O设备发出命令时，要求I/O设
备能作出响应，如果I/O接口不具备传送命令信
息的功能，那么设备将无法响应，故通常在I/O
接口中设有存放命令的命令寄存器和命令译码:
器
命令寄存器不会随意地接收命令线上的命令
码(I/O 指令中的命令码字段)。只有当此接口的
设备选择电路输出了SEL信号，命令寄存器才会
接收。

				- ![](assets/e8c22dbcea678b042a361944abf46d35459d964b3a32ef090ff65ebc307b9a5d.png)

		- 传送数据

			- 由于IO接口处于主机和I/O设备之间，因此主机和I/O设备之间传送数据必须通过接口
才能实现。这就要求接口中必须具有数据通路，完成数据传送。这种数据通路还应具有缓冲
能力，即能将数据暂存在接口内。接口中通常设有数据缓冲寄存器，用来暂存I/O设备与主
机准备交换的信息，其与I/O总线中的数据线是相连的。

		- 反映I/O设备工作状态

			- 并不是数据发过来就能接收的。因为可能此时还没有准备好，所以接口
内必须设置--些反映设备工作状态的触发器。

	- 基本结构

		- 现代计算机一般都采用了中断技术，因此接口电路中一般还设有中断请求触发器
(INTR)，当其为“1”时，表示该I/O设备向CPU发出中断请求。接口内还有屏蔽触发器
(MASK),它与中断请求触发器配合使用，完成设备的屏蔽功能。
内部接口:内部接口与系统总线相连，实质上是与内存、CPU相连。数据的传输方式只
能是并行传输。
外部接口:外部接口通过接口电缆与外设相连，外部接口的数据传输可能是串行方式，
因此IO接口需具有串/并转换功能。

			- ![](assets/4f5659c9adb32dac921607f459395f91b19fb75e1c267e2b3cd74560bbb11254.png)

	- 接口类型

		- (1)按照数据传送方式分类，I/O接口可分为并行接口和串行接口。并行接口可以同时传
送一个字节或一个字的所有位，串行接口只能一位一位地传送。
(2)按主机访问I/O设备的控制方式可以分为程序查询接口，中断接口和DMA接口。
(3)按功能选择的灵活性可分为可编程接口和不可编程接口。

## 端口与编址

- 端口

	- 端口指可以由CPU进行读或写的寄存器。这些
寄存器分别用来存放数据信息、控制信息和状态信息，分别称为数据端口、控制端口和状态
端口。若千个端口加上相应的控制逻辑电路就组成了接口。
一个I/O接口可能有多个地址。因为一个I/O接口中可能有多个用户可访问的寄
存器，也就是多个I/O端口，而每个I/O端口有一一个地址，所以一个IO接口可能有多个地址。

- 端口编址

	- 一般将 I/O设备码看作地址码。I/O地址码的编址一般采用两种方式:统-编址和不统一
编址。前面讲过了存储器地址，如果能将I/O的地址码和主存的地址码统一起来就方便多 了，
即统一编址。例如，在64KB地址的存储空间中，划出8KB地址作为I/O设备的地址，凡是
在这8KB地址范围内的访问，就是对I/O设备的访问，所用的指令和访存指令相似。显然，
统一-编址占用了存储空间，减少了主存容量，但无须专用的I/O指令。不统一编址指I/O地址和存储器地址是分开的，所有对I/O 设备的访问必须有专用的I/O 指令。不统- -编址由于
不占用主存空间，故不影响主存容量，但需要设置I/O专用指令。因此，设计机器时，需根
据实际情况衡量考虑选取何种编址方式。
注意:当I/O设备通过接口与主机相连时，CPU可以通过接口地址来访问I/O设备。因
为一个接口对应一个I/O设备。

## I/O方式

- 程序查询方式

	- 程序查询方式又称为程序控制I/O方式。在这种方
式中，数据在CPU和外部设备之间的传送完全靠计算机程序控制，是在CPU主动控制下进行的。当需要输入/输出时，CPU暂停执行主程序，转去执行设备输入/输出的服务程序(指由I/O指令编写成的程序)，根据服务程序中的I/O指令进行数据传送。从上面的故事中可以看出程序查询方式的主要缺点在于每时每刻需要不断查询I/O设备是否准备就绪。当I/O设备较多时，CPU需要按各个I/O设备在系统中的优先级别进行逐级查询，使用轮询方法

		- ![](assets/3e22992d0c9ad3da3625d87c4a3ede0a33c450b8cb7883bb2e1f8df4988d6c00.png)

	- 指令

		- 1)测试指令。用来查询I/O设备是否准备就绪。
2)转移指令。若I/O设备未准备就绪，则执行转移指令，即转到测试指令，继续测试I/O
设备的状态。
3)传送指令。若I/O设备准备就绪，则执行传送指令。

	- 完整流程

		- ![](assets/5a9864f922f239c12c39e4fed1588128e0c7f843e564671788f147617ea47e5f.png)
		- 1)使用程序查询方式传输数据肯定要用到CPU的寄存器来存取--些信息，但是CPU在
执行程序的过程中肯定已经将一些重要信息存放在这些寄存器里面了，所以前期需要将CPU
存在寄存器里面的重要信息进行保存。
2)数据的传送都是成块传送的，因此需要给出I/O设备与主机交换数据的计数值。
3)给出欲传送数据在主存缓冲区的首地址。
4)启动I/O设备。
5)将I/O接口中的设备状态标志取至CPU,并测试I/O设备是否准备就绪。若I/O设备
没有准备好，则一直等待，直到其准备就绪为止。准备就绪之后，就可以传送数据了。
对于输入而言，准备就绪意味着接口电路中的数据缓冲寄存器已装满欲传送的数据(称
为输入缓冲满)，CPU可以取走数据。
对于输出而言，准备就绪意味着接口电路中的数据已被设备取走(称为输出缓冲空)，这
样CPU可再次将数据送到接口，设备可再次从接口接收数据。
6) CPU执行I/O指令，或从IO接口的数据缓冲寄存器中读出一个数据，或把一一个数据 
写入I/O接口中的数据缓冲寄存器内，并修改接口中的状态标志位。
7)由于当前主存地址的数据已经传送完毕，因此需要修改主存地址。
8)由于计数器是判断数据传完与否的唯一标志， 因此每传输完-一个数据之后，一.定要记
得修改计数值。
9)判断计数值，若计数值不为0,则表示- -批数据尚未传送完，重新启动外设继续传送;
若计数值为0，则表示- ~批数据已传送完毕。
10)若传送完，结束I/O传送，继续执行现行程序。

- 程序中断

	- ![](assets/31140c7adeff0b982934eabb575dd51b9d8fbd82a21a728a991a3960c6511892.png)
	- 1)cpu通过I/O指令的地址码已经选中某设备，由CPU发启动I/O设备命令，将接口中的B置“1”，D置“0”。
2)接口启动输入设备开始工作。
3)输入设备将数据送入数据缓冲寄存器。
4)输入设备向接口发出“设备工作结束”信号，将D置“1”，B置“0”,标志设备准备
就绪。
5)当设备准备就绪(D=1)， 且本设备未被屏蔽(MASK=0)时，在指令执行阶段的结
束时刻，由CPU发出中断查询信号。
6)设备中断请求触发器INTR被置“1”，标志设备向CPU提出中断请求。与此同时，
INTR送至排队器，进行中断判优。
7)若CPU允许中断(EINT=1)， 设备又被排队器选中，即进入中断响应阶段，由中断
响应信号INTA将排队器输出送至编码器形成向量地址。
8)向量地址被送至PC,作为下一条指令的地址。
9)由于向量地址中存放的是- - 条无条件转移指令，因此这条指令执行结束后，即无条件
转至该设备的服务程序入口地址，开始执行中断服务程序，进入中断服务阶段，通过输入指
令将数据缓冲寄存器的输入数据送至CPU的通用寄存器，再存入主存单元。
10)中断服务程序的最后一条指令是中断返回指令，当其执行结束时，即中断返回至原程序的断点处。至此，一个完整的程序中断处理过程即告结束。

- DMA

	- 特点

		- ![](assets/7ffde43c90dba18b04ac340d9468e93aea23bd4c328db1383634c651c89ccfb0.png)
		- DMA方式是--种完全由硬件进行成组信息传送的控制方式，具有程序中断方式的优点，
即在数据准备阶段，CPU与外设并行。它还降低了CPU在传送数据时的开销，这是因为信息
传送不再经过CPU，而在外设与内存之间直接进行，因此称为直接存储器存取方式。由于数
据传送不经过CPU,也就不需要保护、恢复CPU现场等烦琐操作。这种方式适用于磁盘、磁
带等高速设备大批量数据的传送。它的硬件开销比较大，DMA方式中，中断的作用仅限于故
障和正常传送结束时的处理。

	- 传送方法
DMA采用周期窃取的方式占用一个存储周期

		- 停止CPU访问主存

			- 当外设需要传送一片 数据时，由DMA接口向CPU发一个信号，要求CPU放弃地址线、
数据线和有关控制线的使用权，DMA接口获得总线控制权后,开始进行数据传送。在数据传
送结束后，DMA接口通知CPU可以使用主存，并把总线控制权交还给CPU。在这种传送过程中，CPU基本处于不工作状态或保持原始状态。

这种传送方式控制简单，适用于数据传输速率很高的设备成组传送。其缺点是:在访存阶段，主存的效能未充分发挥。这是因为设备在传送一批数据时，CPU不能访问主存，而主存的速度远远高于设备的速度，即使是高速外设，在两个数据之间的准备间隔时间也总是大于一个存储周期，
使相当一部分主存周期是空闲的。为了提高主存的利用率，可采用周期挪用方式
			- ![](assets/6a50a8011bb3ff84181b215b5ee0e8003c80f5312f9255be0791e15a7002743a.png)

		- 周期挪用

			- 当I/O设备没有DMA请求时, CPU按程序的要求访问主存,一-旦I/O设备有DMA请求,就会遇到3种情况:第- -种情况是 CPU不在访存(CPU正在执行加法指令)，故IO的访存请求与CPU未发生冲突;第二种情况是CPU正在访存，必须等待存储周期结束后，CPU再将总线占有权让出;第三种情况是IO和CPU同时请求访存，出现了访存冲突，此刻CPU要暂时放弃总线占有权，由I/O设备挪用一个或几个存储周期，与停止CPU访问主存方式相
比，它既实现了I/O 传送，又较好地发挥了主存与CPU的效率，是一种广泛采用的方法。

注意:IO设备每挪用一个主存周期都要申请总线控制权、建立总线控制权和归还总线控制权。
			- ![](assets/3a3c715fdfecf58c3f46444da3abad955bde644b659afab02b8047683f83d36f.png)

		- DMA与CPU交替访问

			- 适用于CPU的工作周期比主存存取周期长的情况，例如，CPU的工作周期是1.2μs，主存的存取周期小于0.6μs，那么可将-一个CPU周期分为C1和C2两个周期，其中C1专供DMA访存，C2专供CPU访存
这种方式不需要总线使用权的申请、建立和归还过程，总线使用权是通过Ci和C2分时
控制的。实际上总线变成了在C1和C2控制下的多路转换器，总线控制权的转移几乎不需要
时间，具有很高的DMA传送效率。CPU既不停止主程序的运行，也不进入等待状态，完成
了DMA的数据传送。
			- ![](assets/99766a89cdc021fdd4de86383f04bbd2f119b37da7ffae75688b95d104db8dcb.png)

	- 功能组成

		- 功能

			- 1)向CPU申请DMA数据传送。
2)在CPU允许DMA工作时，处理总线控制权的转交，避免因进入DMA工作而影响CPU正常活动或引起总线竞争。
3)在DMA期间管理系统总线，控制数据传送。
4)确定数据传送的起始地址和数据长度，并修正数据传送过程中的数据地址和数据长度。
5)在数据块传送结束时，给出DMA操作完成的信号。

		- 基本结构

			- AR:存放数据块在主存的首地址，有
计数功能。
WC:为字计数器，存放交换数据的
字数。
DAR:为设备地址寄存器，用于存放
设备号。
BR:为数据缓冲寄存器，存放主存和
设备之间交换的数据字。
以上这些信息均在DMA传送的预处
理阶段由CPU经数据线送至DMA接口内。
			- DMA控制逻辑:用于负责管理DMA的传送过程，由控制电路、时序电路和命令状态寄存器等组成。
中断逻辑(中断机构):当字计数器溢出(全“0”)时，表示- -批数据交换完毕，由“溢出信号”通过中断机构向CPU提出中断请求，请求CPU对DMA操作进行后处理。
			- ![](assets/6f69a1e26a258035629cc55625e8a9616ba663a3f385610786b3d5dee66eed66.png)

		- 传送过程

			- 预处理

				- 在DMA接口开始工作之前，CPU必须做如下工作:
1)指明是输入数据还是输出数据。
2)向DMA设备地址寄存器(DAR)送入设备号，并启动设备。
3)向DMA主存地址寄存器(AR) 送入交换数据的主存首地址。
4)对字计数器(WC)赋予交换数据的个数。
预处理完了,接下来I/O设备就要通过DMA接口向CPU提出占用总线的申请，很有可能多个DMA同时申请，所以需要由硬件排队判优逻辑决定哪
个I/O设备拿到总线，拿到主存总线后，就可以进行数据传送了。
				- ![](assets/197b4c8bbd4efb84013eb176bae5cf37fd79722b62417457f7ebcc4bec15e348.png)

			- 数据传送（数据块）

				- 1)当设备准备好一个字时，将该字读到DMA的数据缓冲寄存器(BR)中，表示数据
缓冲寄存器“满”。
2)与此同时设备向DMA接口发请求(DREQ)。
3)DMA接口向CPU申请总线控制权(HRQ)。
4) CPU发出HLDA信号，表示允许将总线控制权交给DMA接口。
5)将DMA主存地址寄存器中的主存地址送地址总线，并命令存储器写。
6) DMA控制逻辑告诉I/O，CPU已经安排了一个DMA周期，记住为下一个字的传送
做准备。
7)将DMA数据缓冲寄存器的内容送数据总线。
8)主存将数据总线上的信息写至地址总线指定的存储单元中。
9)修改主存地址和字计数值。
				- ![](assets/5c5c2723a5f15c6bdc56c8442c232014192e80e985a5cc6548ed300c120104fc.png)

			- 后处理

				- 当DMA的中断请求得到响应后，CPU停止原程序的执行，转去执行中断服务程序，做
一些DMA的结束工作。后处理部分包括校验送入主存的数据是否正确;决定是否继续用DMA传送其他数据块(若继续传送，则又要对DMA接口进行初始化，若不需要传送，则停止外设);测试在传送过程中是否发生错误(若有错误，则转错误诊断及处理错误程序)。

	- 1)从数据传送来看，程序中断方式靠程序传送，DMA方式靠硬件传送。
2)从CPU响应时间来看，程序中断方式是在二条指令执行结束时响应，而DMA方式
可在指令周期内的任意存储周期结束时响应。
3)程序中断方式有处理异常事件的能力; DMA方式没有这种能力，主要用于大批数据
的传送。
4)程序中断方式需要中断现行程序，故需保护现场; DMA方式不需中断现行程序，无
须保护现场。
5) DMA的优先级比程序中断的优先级高。

